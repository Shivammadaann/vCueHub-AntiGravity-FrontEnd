<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>vCue Hub · Team Dashboards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Favicon -->
    <link rel="icon" href="assets/Favicon.png" type="image/x-icon">
    <style>
        /* (all existing styles – unchanged, plus mobile enhancements and new card animations) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: #0a0f1e;
            min-height: 100vh;
            display: flex;
        }

        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes glowPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
            }

            70% {
                box-shadow: 0 0 20px 10px rgba(59, 130, 246, 0.2);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.2, 0.9, 0.3, 1) forwards;
        }

        .scale-in {
            animation: scaleIn 0.3s ease forwards;
        }

        #department-dashboard,
        #gmeet-pane,
        #pipeline-pane,
        #store-dashboard,
        #home-analytics,
        #user-management-pane {
            animation: fadeIn 0.4s ease;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            transition: backdrop-filter 0.3s ease, background 0.3s ease;
        }

        .modal-content {
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1), opacity 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* ===== DROPDOWN ===== */
        .filter-dropdown {
            display: block;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            position: absolute;
            background: #1f2a37;
            border-radius: 16px;
            padding: 12px 0;
            min-width: 180px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 15px 30px -10px black;
            border: 1px solid #374151;
        }

        .filter-dropdown.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* ===== TOAST ===== */
        .toast {
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1), opacity 0.3s ease;
            transform: translateX(120%);
        }

        .toast.show {
            transform: translateX(0);
        }

        /* ===== CARD STYLES ===== */
        .nav-item,
        .admin-card,
        .dept-option,
        .btn,
        .read-more-btn,
        .clear-btn,
        .filter-chip,
        .source-badge,
        .status-badge {
            transition: all 0.2s ease;
        }

        .stats-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 28px -8px rgba(0, 0, 0, 0.6);
        }

        tr {
            transition: background 0.15s ease;
        }

        .filter-chip {
            animation: slideUp 0.2s ease;
        }

        .dept-option:hover {
            transform: scale(1.02) translateY(-4px);
            box-shadow: 0 24px 36px -12px #000000cc;
        }

        /* Enhanced admin cards */
        .admin-card {
            background: #242f3f;
            border-radius: 28px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
            border: 2px solid transparent;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.5);
        }

        .admin-card:hover {
            transform: translateY(-12px) scale(1.02);
            border-color: #3b82f6;
            box-shadow: 0 25px 30px -10px #2563eb80;
            animation: glowPulse 2s infinite;
        }

        .admin-card i {
            transition: transform 0.3s ease;
        }

        .admin-card:hover i {
            transform: scale(1.1);
        }

        .btn-primary,
        .btn-secondary {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover,
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px -6px #2563eb80;
        }

        .btn-primary:active,
        .btn-secondary:active {
            transform: translateY(0);
        }

        .search-wrapper:focus-within,
        .date-wrapper:focus-within {
            box-shadow: 0 0 0 2px #3b82f640;
            transition: box-shadow 0.2s;
        }

        .filterable-th i {
            transition: transform 0.2s ease;
        }

        .filterable-th:hover i {
            transform: translateY(-50%) rotate(180deg);
        }

        .pipeline-owner-card {
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s;
        }

        .pipeline-owner-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 24px 32px -14px #000000;
        }

        .nav-item.active {
            background: #2563eb20;
            color: #60a5fa;
            border-left: 3px solid #3b82f6;
            transition: all 0.2s ease;
        }

        .nav-item.nav-accordion {
            justify-content: space-between;
        }

        .nav-item-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-accordion-icon {
            font-size: 0.75rem;
            color: #6b7280;
            transition: transform 0.2s ease, color 0.2s ease;
        }

        .nav-item.nav-accordion.expanded .nav-accordion-icon {
            transform: rotate(180deg);
            color: #93c5fd;
        }

        .leads-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease;
        }

        .leads-submenu.open {
            max-height: 1000px;
        }

        .nav-sub-item {
            padding: 10px 14px 10px 46px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #9ca3af;
            cursor: pointer;
            margin: 4px 8px;
            border-radius: 10px;
            font-size: 0.92rem;
            transition: all 0.2s ease;
        }

        .nav-sub-item:hover {
            background: #1f2937;
            color: white;
        }

        .nav-sub-item.active {
            background: #2563eb20;
            color: #60a5fa;
            border-left: 3px solid #3b82f6;
        }

        .hidden-pane {
            display: none;
        }

        .active-pane {
            display: block;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: #111827;
            border-right: 1px solid #1f2937;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            color: #e5e7eb;
            transition: transform 0.3s ease;
            z-index: 500;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar>* {
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-header img {
            height: 32px;
            width: auto;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-item {
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #9ca3af;
            cursor: pointer;
            margin: 4px 8px;
            border-radius: 10px;
        }

        .nav-item:hover {
            background: #1f2937;
            color: white;
        }

        .admin-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid #1f2937;
            font-size: 0.9rem;
        }

        .sidebar-profile-trigger {
            width: 100%;
            display: block;
            font: inherit;
            color: inherit;
            text-align: left;
            background: #0f172a;
            border: 1px solid #243244;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
        }

        .sidebar-profile-trigger:hover {
            background: #162135;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .sidebar-profile-trigger:focus-visible {
            outline: 2px solid #60a5fa;
            outline-offset: 2px;
        }

        .sidebar-profile-edit-note {
            margin-top: 7px;
            color: #93c5fd;
            font-size: 0.74rem;
        }

        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 24px;
            background: #0f1525;
            min-height: 100vh;
            position: relative;
            transition: margin-left 0.3s ease;
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 600;
            background: #1f2937;
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 70px 16px 16px;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
                border-radius: 24px;
            }

            .search-wrapper {
                width: 100%;
            }

            .date-wrapper {
                width: 100%;
                justify-content: space-between;
            }

            .dept-select-card .grid {
                grid-template-columns: 1fr;
            }

            .admin-info {
                padding: 16px;
            }

            .pipeline-grid {
                grid-template-columns: 1fr;
            }
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0f1e;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: #1a2332;
            border-radius: 36px;
            padding: 42px 34px;
            width: 92%;
            max-width: 540px;
            margin-bottom: 20px;
        }

        .login-subtitle {
            text-align: center;
            color: #9ca3af;
            margin-top: 10px;
            margin-bottom: 22px;
            font-size: 0.98rem;
        }

        .login-step-title {
            color: #f8fafc;
            font-size: 1.28rem;
            font-weight: 700;
            margin-bottom: 6px;
            text-align: left;
        }

        .login-step-desc {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 16px;
            text-align: left;
        }

        .login-back-btn {
            margin-top: 12px;
            background: transparent;
            color: #93c5fd;
            border: none;
            cursor: pointer;
            font-size: 0.86rem;
            text-decoration: underline;
        }

        .login-back-btn:hover {
            color: #bfdbfe;
        }

        /* Footer styles */
        .login-footer {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
            font-size: 0.95rem;
            background: transparent;
            width: 100%;
        }

        .login-footer a {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
        }

        .login-footer a:hover {
            text-decoration: underline;
            color: #93c5fd;
        }

        .login-footer i {
            margin-right: 6px;
            color: #3b82f6;
        }

        #dept-select-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f1525;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .dept-select-card {
            background: #1a2332;
            border-radius: 32px;
            padding: 40px;
            width: 90%;
            max-width: 900px;
            text-align: center;
        }

        .dept-option {
            background: #242f3f;
            border-radius: 28px;
            padding: 40px 20px;
            cursor: pointer;
            transition: 0.25s;
            border: 1px solid #374151;
        }

        .dept-option:hover {
            transform: scale(1.02);
            background: #2d3a4d;
            border-color: #3b82f6;
            box-shadow: 0 20px 30px -10px #00000080;
        }

        .dept-option i {
            font-size: 2.8rem;
            margin-bottom: 15px;
        }

        .dept-option h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .dept-option p {
            color: #9ca3af;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000cc;
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1a2332;
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 650px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e5e7eb;
        }

        .password-modal-card {
            max-width: 520px;
            border-radius: 36px;
            padding: 40px 34px 28px;
            text-align: center;
            background: linear-gradient(160deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.94));
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 28px 60px -24px rgba(37, 99, 235, 0.45);
        }

        .password-brand {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .password-brand-logo {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 18px;
            box-shadow: 0 10px 20px -10px rgba(59, 130, 246, 0.75);
        }

        .password-brand-title {
            font-size: 2.1rem;
            font-weight: 800;
            color: #ffffff;
            letter-spacing: 0.4px;
        }

        .password-user-avatar {
            width: 96px;
            height: 96px;
            border-radius: 999px;
            overflow: hidden;
            margin: 4px auto 14px;
            border: 3px solid rgba(148, 163, 184, 0.5);
            box-shadow: 0 12px 24px -14px rgba(15, 23, 42, 0.95);
            background: #374151;
        }

        .password-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .password-user-name {
            font-size: 1.25rem;
            color: #f8fafc;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .password-user-designation {
            color: #94a3b8;
            font-size: 0.92rem;
            margin-bottom: 22px;
        }

        .password-input-wrap {
            position: relative;
            margin-bottom: 18px;
        }

        .password-input {
            width: 100%;
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 20px;
            background: rgba(30, 41, 59, 0.58);
            backdrop-filter: blur(10px);
            color: #f8fafc;
            padding: 16px 52px 16px 18px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .password-input::placeholder {
            color: #94a3b8;
        }

        .password-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .password-input.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .password-toggle-btn {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .password-toggle-btn:hover {
            color: #cbd5e1;
        }

        .password-signin-btn {
            width: 100%;
            border: none;
            border-radius: 18px;
            padding: 15px 18px;
            color: #ffffff;
            font-weight: 700;
            font-size: 1rem;
            background: linear-gradient(135deg, #3b82f6 0%, #7c3aed 100%);
            box-shadow: 0 16px 28px -16px rgba(124, 58, 237, 0.9);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }

        .password-signin-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
            box-shadow: 0 18px 30px -16px rgba(59, 130, 246, 0.85);
        }

        .password-signin-btn:active {
            transform: translateY(0);
        }

        .password-signin-btn i {
            margin-right: 8px;
        }

        .password-error-message {
            min-height: 18px;
            margin: -8px 0 12px;
            color: #fca5a5;
            font-size: 0.86rem;
            text-align: left;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .password-error-message.show {
            opacity: 1;
        }

        .password-input-wrap.shake {
            animation: passwordShake 0.38s ease;
        }

        @keyframes passwordShake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-7px);
            }

            40% {
                transform: translateX(7px);
            }

            60% {
                transform: translateX(-5px);
            }

            80% {
                transform: translateX(5px);
            }
        }

        .password-helper-text {
            margin-top: 16px;
            color: #94a3b8;
            font-size: 0.86rem;
        }

        @media (max-width: 640px) {
            .password-modal-card {
                padding: 28px 20px 22px;
                border-radius: 28px;
            }

            .password-brand-title {
                font-size: 1.8rem;
            }

            .login-card {
                padding: 30px 20px;
                border-radius: 24px;
            }
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: #242f3f;
            border: 1px solid #374151;
            border-radius: 12px;
            color: white;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #2d3a4d;
            color: white;
        }

        .lead-row-selected {
            background: #1e3a8a66 !important;
        }

        .table-container {
            background: #1a2332;
            border-radius: 20px;
            overflow-x: auto;
            margin-top: 16px;
            position: relative;
            border: 1px solid #2a3547;
            box-shadow: 0 18px 30px -24px #000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            text-align: left;
            padding: 18px 12px;
            background: #242f3f;
            color: #9ca3af;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
            position: relative;
            letter-spacing: 0.04em;
            border-bottom: 1px solid #334155;
        }

        .filterable-th {
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
            padding-right: 28px;
        }

        .filterable-th:hover {
            background: #2d3a4d;
            color: white;
        }

        .filterable-th i {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            opacity: 0.7;
            transition: transform 0.2s;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid #2d3a4d;
            color: #e5e7eb;
            vertical-align: middle;
        }

        .col-name {
            width: 18%;
        }

        .col-email {
            width: 16%;
        }

        .col-phone {
            width: 12%;
        }

        .col-source {
            width: 10%;
        }

        .col-budget {
            width: 10%;
        }

        .col-owner {
            width: 12%;
        }

        .col-stage {
            width: 8%;
        }

        .col-remark {
            width: 14%;
        }

        tbody tr:hover {
            background: #242f3f;
        }

        .lead-name-cell {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 10px;
        }

        .lead-name-text {
            white-space: normal;
            overflow-wrap: anywhere;
            line-height: 1.35;
        }

        .remark-cell {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
            height: 100%;
        }

        .remark-preview {
            flex: 1;
            color: #d1d5db;
            font-size: 0.85rem;
            line-height: 1.35;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            word-break: break-word;
            max-height: 58px;
        }

        .read-more-btn {
            background: #2d3a4d;
            border: none;
            color: #93c5fd;
            font-size: 0.78rem;
            padding: 7px 12px;
            border-radius: 30px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            flex-shrink: 0;
        }

        .read-more-btn:hover {
            background: #3b4a62;
            color: white;
        }

        #dept-table,
        #store-table {
            min-width: 1280px;
        }

        #dept-table th,
        #store-table th {
            text-align: center;
        }

        #dept-table .filterable-th {
            text-align: center;
            padding-left: 28px;
            padding-right: 28px;
        }

        #dept-table td,
        #store-table td {
            height: auto;
            overflow: visible;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-hot {
            background: #7f1d1d;
            color: #fecaca;
        }

        .status-warm {
            background: #854d0e;
            color: #fef9c3;
        }

        .status-cold {
            background: #1e3a8a;
            color: #bfdbfe;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1a2332;
            border-left: 4px solid #3b82f6;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            display: none;
            z-index: 3000;
        }

        .toast.show {
            display: block;
        }

        .stats-card {
            background: #1a2332;
            border-radius: 16px;
            padding: 20px;
        }

        .source-badge {
            background: #374151;
            color: #e5e7eb;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-block;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            background: #1a2332;
            padding: 16px 20px;
            border-radius: 40px;
            margin-bottom: 20px;
        }

        .search-wrapper {
            flex: 2;
            min-width: 240px;
            display: flex;
            align-items: center;
            background: #242f3f;
            border-radius: 40px;
            padding: 0 16px;
            transition: box-shadow 0.2s;
        }

        .search-wrapper i {
            color: #6b7280;
        }

        .search-wrapper input {
            background: transparent;
            border: none;
            padding: 12px 12px;
            color: white;
            width: 100%;
            outline: none;
        }

        .date-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #242f3f;
            padding: 6px 16px;
            border-radius: 40px;
            transition: box-shadow 0.2s;
        }

        .date-wrapper label {
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .date-wrapper input[type="date"] {
            background: transparent;
            border: none;
            color: white;
            padding: 8px 0;
            font-size: 0.9rem;
        }

        .date-wrapper input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        .clear-btn {
            background: #2d3a4d;
            border-radius: 30px;
            padding: 8px 18px;
            color: #d1d5db;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
        }

        .clear-btn:hover {
            background: #3b4a62;
            transform: scale(0.97);
        }

        .lead-form-modal-card {
            width: min(92vw, 900px);
            max-width: 900px;
            max-height: 92vh;
            overflow-y: auto;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 20px;
            padding: 0;
        }

        .lead-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #2d3a4d;
            background: linear-gradient(135deg, #1d4ed8, #1e3a8a);
        }

        .lead-form-body {
            padding: 22px 24px 14px;
        }

        .lead-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .lead-form-field label {
            display: block;
            color: #cbd5e1;
            font-size: 0.85rem;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .lead-form-field .input-field {
            margin-bottom: 0;
        }

        .lead-form-remark {
            min-height: 120px;
            resize: vertical;
            margin-top: 6px;
        }

        .lead-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 18px 24px 24px;
            border-top: 1px solid #2d3a4d;
            background: #0f172a;
            flex-wrap: wrap;
        }

        .row-edit-btn {
            background: #1e40af;
            color: #dbeafe;
        }

        .row-edit-btn:hover {
            background: #1d4ed8;
            color: #ffffff;
        }

        .timeline-item {
            cursor: pointer;
        }

        .timeline-item.active .timeline-content {
            border-color: #60a5fa;
            background: #1e3a8a33;
        }

        .timeline-item.active .timeline-badge {
            border-color: #60a5fa;
            background: #1e3a8a;
        }

        .remark-editor {
            margin-top: 16px;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #2d3a4d;
            background: #0f172a;
        }

        .remark-editor-label {
            display: block;
            color: #cbd5e1;
            font-size: 0.84rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .remark-editor-input {
            width: 100%;
            min-height: 90px;
            border-radius: 10px;
            border: 1px solid #334155;
            background: #111827;
            color: #f3f4f6;
            padding: 10px 12px;
            resize: vertical;
            outline: none;
        }

        .remark-editor-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #2563eb33;
        }

        .remark-editor-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .remark-editor-hint {
            font-size: 0.78rem;
            color: #9ca3af;
            margin-top: 8px;
        }

        .user-admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin: 26px 0 14px;
            flex-wrap: wrap;
        }

        .user-feature-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .user-feature-pill {
            background: #243244;
            color: #bfdbfe;
            border-radius: 999px;
            padding: 3px 10px;
            font-size: 0.72rem;
            white-space: nowrap;
        }

        .user-role-badge-admin {
            background: #1e3a8a;
            color: #bfdbfe;
        }

        .user-role-badge-team {
            background: #0f766e;
            color: #ccfbf1;
        }

        .danger-btn {
            background: #7f1d1d;
            color: #fecaca;
        }

        .danger-btn:hover {
            background: #991b1b;
            color: #fee2e2;
        }

        .user-modal-card {
            width: min(94vw, 980px);
            max-width: 980px;
            max-height: 92vh;
            overflow-y: auto;
            background: #111827;
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 0;
        }

        .user-modal-body {
            padding: 22px 24px 14px;
        }

        .user-modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .feature-access-grid {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 10px;
        }

        .feature-access-item {
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #334155;
            border-radius: 10px;
            background: #0f172a;
            padding: 10px 12px;
            color: #dbeafe;
            font-size: 0.84rem;
            user-select: none;
        }

        .feature-access-item input {
            accent-color: #3b82f6;
        }

        .feature-access-legend {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 8px;
        }

        .profile-settings-card {
            width: min(92vw, 760px);
            max-width: 760px;
        }

        .profile-picture-preview-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #334155;
            border-radius: 12px;
            background: #0f172a;
            padding: 10px 12px;
            margin-bottom: 14px;
        }

        .profile-picture-preview {
            width: 54px;
            height: 54px;
            border-radius: 999px;
            object-fit: cover;
            border: 2px solid #334155;
            background: #1f2937;
        }

        .profile-email-note {
            margin-top: 6px;
            font-size: 0.78rem;
            color: #94a3b8;
        }

        .profile-email-note.locked {
            color: #fbbf24;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 12px 10px;
            margin: 10px 0;
        }

        .detail-label {
            color: #9ca3af;
        }

        .dept-indicator {
            display: inline-block;
            background: #1f2a37;
            padding: 6px 18px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 500;
            margin-left: 15px;
        }

        .proposal-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .proposal-yes {
            background: #065f46;
            color: #d1fae5;
        }

        .proposal-no {
            background: #7f1d1d;
            color: #fee2e2;
        }

        .filter-chip {
            background: #2d3a4d;
            border-radius: 30px;
            padding: 4px 12px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-right: 8px;
            color: #bfdbfe;
        }

        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .pipeline-owner-card {
            background: #1e2a3a;
            border-radius: 24px;
            padding: 22px 20px;
            border-left: 6px solid;
        }

        .pipeline-total-card {
            background: linear-gradient(145deg, #1f2a37, #1a2532);
            border-radius: 28px;
            padding: 28px;
            margin-bottom: 25px;
            border: 1px solid #3b82f620;
        }

        .amount-display {
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }

        /* ===== TIMELINE STYLES ===== */
        .timeline-item {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-badge {
            width: 44px;
            height: 44px;
            background: #2d3a4d;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px solid #3b82f6;
            box-shadow: 0 6px 12px -6px #1e3a8a;
        }

        .timeline-badge i {
            font-size: 1.2rem;
            color: #93c5fd;
        }

        .timeline-content {
            background: #1e2a3a;
            border-radius: 18px;
            padding: 16px 20px;
            flex: 1;
            border-left: 4px solid #3b82f6;
        }

        .timeline-date {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timeline-date i {
            color: #3b82f6;
            font-size: 0.7rem;
        }

        .timeline-text {
            color: #e5e7eb;
            line-height: 1.5;
            white-space: pre-line;
        }

        .timeline-item:not(:last-child) .timeline-badge::after {
            content: '';
            position: absolute;
            left: 21px;
            top: 48px;
            width: 2px;
            height: calc(100% + 4px);
            background: #374151;
            transform: translateX(-50%);
            z-index: 0;
        }

        .popup-remark-block {
            background: transparent;
            padding: 0;
            margin: 16px 0 8px;
            border-left: none;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 6px;
        }

        /* Store dashboard */
        .store-placeholder {
            background: #1a2332;
            border-radius: 32px;
            padding: 60px 20px;
            text-align: center;
            color: #9ca3af;
            font-size: 1.5rem;
            margin-top: 30px;
        }

        /* GMeet filter bar with two dropdowns */
        .gmeet-filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            background: #1a2332;
            padding: 12px 20px;
            border-radius: 40px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .owner-filter-select {
            background: #242f3f;
            border: 1px solid #374151;
            color: white;
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            min-width: 200px;
        }

        /* Contact action icons */
        .contact-action {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .contact-icon {
            color: #9ca3af;
            transition: color 0.2s ease;
            font-size: 1rem;
        }

        .contact-icon:hover {
            color: #3b82f6;
            transform: scale(1.1);
        }

        .email-icon:hover {
            color: #ea4335;
        }

        .whatsapp-icon:hover {
            color: #25D366;
        }

        /* Modern Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0f1e;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards;
        }

        .loading-spinner {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
        }

        .spinner-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 50%;
            animation: spin var(--speed) linear infinite;
        }

        .spinner-ring:nth-child(1) {
            --speed: 1s;
            border-top-color: #3b82f6;
            border-left-color: #3b82f6;
            animation-timing-function: cubic-bezier(0.65, 0, 0.35, 1);
        }

        .spinner-ring:nth-child(2) {
            --speed: 1.5s;
            width: 90%;
            height: 90%;
            top: 5%;
            left: 5%;
            border-right-color: #10b981;
            border-bottom-color: #10b981;
            animation-direction: reverse;
            animation-timing-function: cubic-bezier(0.65, 0, 0.35, 1);
        }

        .spinner-ring:nth-child(3) {
            --speed: 2s;
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border-top-color: #f59e0b;
            border-right-color: #f59e0b;
            animation-timing-function: cubic-bezier(0.65, 0, 0.35, 1);
        }

        .spinner-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: #1a2332;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            animation: pulse 2s ease infinite;
        }

        .loading-logo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .loading-text {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .loading-subtext {
            color: #9ca3af;
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.8;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
                transform: translate(-50%, -50%) scale(1.05);
            }
        }

        /* Mobile responsive for loader */
        @media (max-width: 768px) {
            .loading-spinner {
                width: 100px;
                height: 100px;
            }

            .spinner-center {
                width: 50px;
                height: 50px;
            }

            .loading-logo {
                width: 30px;
                height: 30px;
            }

            .loading-text {
                font-size: 1.5rem;
            }

            .loading-subtext {
                font-size: 0.9rem;
            }
        }

        /* Modern Lead Details Modal */
        .modern-modal {
            background: linear-gradient(145deg, #1a2332 0%, #1e2a3a 100%);
            border-radius: 32px;
            padding: 0;
            max-width: 700px;
            width: 95%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.1);
            overflow: hidden;
            animation: modalSlideUp 0.4s cubic-bezier(0.2, 0.9, 0.3, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #2563eb20 0%, #1e2a3a 100%);
            padding: 24px 28px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 2px solid #2d3a4d;
            position: relative;
        }

        .header-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px -5px #2563eb80;
        }

        .header-icon i {
            font-size: 32px;
            color: white;
        }

        .header-title {
            flex: 1;
        }

        .header-title h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #fff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .lead-id {
            color: #9ca3af;
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .modal-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: #2d3a4d;
            border: none;
            color: #9ca3af;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: #ef4444;
            color: white;
            transform: rotate(90deg);
        }

        /* Lead Info Grid - Modern Layout */
        .lead-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px 24px;
            padding: 28px;
            background: #1a2332;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 16px;
            background: #1e2a3a;
            border-radius: 18px;
            border: 1px solid #2d3a4d;
            transition: all 0.2s ease;
        }

        .info-item:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -8px #2563eb80;
        }

        .info-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-label i {
            width: 20px;
            color: #3b82f6;
            font-size: 0.9rem;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            padding-left: 28px;
            word-break: break-word;
        }

        .info-value.email-value {
            color: #60a5fa;
            text-decoration: underline;
            text-decoration-color: #3b82f640;
            text-underline-offset: 4px;
        }

        .info-value.phone-value {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .stage-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stage-badge.hot {
            background: linear-gradient(145deg, #7f1d1d, #991b1b);
            color: #fee2e2;
            box-shadow: 0 4px 12px #7f1d1d80;
        }

        .stage-badge.warm {
            background: linear-gradient(145deg, #854d0e, #a16207);
            color: #fef9c3;
            box-shadow: 0 4px 12px #854d0e80;
        }

        .stage-badge.cold {
            background: linear-gradient(145deg, #1e3a8a, #1e40af);
            color: #bfdbfe;
            box-shadow: 0 4px 12px #1e3a8a80;
        }

        /* Timeline Section */
        .timeline-section {
            padding: 0 28px 28px 28px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #2d3a4d;
        }

        .timeline-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-title i {
            color: #3b82f6;
            font-size: 1.2rem;
            background: #1e2a3a;
            padding: 8px;
            border-radius: 12px;
        }

        .timeline-title h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .timeline-count {
            color: #9ca3af;
            font-size: 0.85rem;
            background: #1e2a3a;
            padding: 4px 12px;
            border-radius: 40px;
            border: 1px solid #2d3a4d;
        }

        .timeline-container {
            max-height: 280px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .timeline-container::-webkit-scrollbar {
            width: 6px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: #1e2a3a;
            border-radius: 10px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }

        /* Timeline Items */
        .timeline-item {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            position: relative;
            animation: timelineSlideIn 0.3s ease forwards;
            animation-delay: calc(--item-index * 0.1s);
            opacity: 0;
        }

        @keyframes timelineSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-badge {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #2d3a4d, #1e2a3a);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px solid #3b82f6;
            box-shadow: 0 8px 16px -8px #2563eb;
            position: relative;
            z-index: 2;
        }

        .timeline-badge i {
            font-size: 1.3rem;
            color: #93c5fd;
        }

        .timeline-content {
            background: #1e2a3a;
            border-radius: 20px;
            padding: 18px 20px;
            flex: 1;
            border: 1px solid #2d3a4d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .timeline-content:hover {
            border-color: #3b82f6;
            transform: translateX(4px);
            box-shadow: 0 8px 20px -8px #2563eb;
        }

        .timeline-date {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
            font-size: 0.85rem;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #2d3a4d;
        }

        .timeline-date i {
            color: #3b82f6;
            font-size: 0.8rem;
        }

        .date-badge {
            background: #2d3a4d;
            padding: 2px 10px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #93c5fd;
        }

        .timeline-text {
            color: #e5e7eb;
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-line;
            word-break: break-word;
        }

        /* Connection line between timeline items */
        .timeline-item:not(:last-child) .timeline-badge::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 48px;
            width: 2px;
            height: calc(100% + 20px);
            background: linear-gradient(to bottom, #3b82f6, #2d3a4d);
            transform: translateX(-50%);
            z-index: 1;
        }

        /* Modal Actions */
        .modal-actions {
            display: flex;
            gap: 12px;
            padding: 20px 28px 28px 28px;
            background: #1a2332;
            border-top: 1px solid #2d3a4d;
        }

        .btn-action {
            padding: 14px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            flex: 1;
        }

        .btn-action i {
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 8px 16px -8px #2563eb;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -8px #2563eb;
            background: linear-gradient(145deg, #4b8df8, #3570e8);
        }

        .btn-secondary {
            background: #2d3a4d;
            color: #e5e7eb;
            border: 1px solid #374151;
        }

        .btn-secondary:hover {
            background: #374151;
            transform: translateY(-2px);
            border-color: #3b82f6;
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            .lead-info-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 20px;
            }

            .modal-header {
                padding: 20px;
            }

            .header-icon {
                width: 48px;
                height: 48px;
            }

            .header-icon i {
                font-size: 28px;
            }

            .header-title h2 {
                font-size: 1.5rem;
            }

            .timeline-section {
                padding: 0 20px 20px 20px;
            }

            .modal-actions {
                padding: 20px;
                flex-direction: column;
            }

            .timeline-badge {
                width: 40px;
                height: 40px;
            }

            .timeline-content {
                padding: 14px 16px;
            }
        }

        /* Overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Modal Container */
        .modern-modal {
            width: 100%;
            max-width: 1000px;
            /* Perfect width for CRM */
            height: 90vh;
            /* Controlled height */
            max-height: 850px;
            /* Avoid over-scaling on big screens */
            background: #111827;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }

        /* Header */
        .modal-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, #2563eb, #1e3a8a);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            font-size: 28px;
        }

        .lead-id {
            font-size: 13px;
            opacity: 0.85;
        }

        /* Body Scroll Section */
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }

        /* Lead Grid */
        .lead-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Timeline Section */
        .timeline-section {
            background: #1f2937;
            padding: 20px;
            border-radius: 16px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timeline-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-container {
            max-height: 280px;
            overflow-y: auto;
            padding-right: 8px;
        }

        /* Footer */
        .modal-actions {
            padding: 18px 25px;
            background: #0f172a;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* Buttons */
        .btn-action {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: 0.2s ease;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #374151;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .modern-modal {
                height: 95vh;
                border-radius: 14px;
            }

            .modal-body {
                padding: 18px;
            }

            .lead-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div id="toast" class="toast"><i class="fas fa-info-circle mr-2 text-blue-400"></i><span id="toast-message"></span>
    </div>
    <!-- Modern Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-center">
                    <img src="assets/logo.jpg" alt="vCue Hub" class="loading-logo">
                </div>
            </div>
            <h3 class="loading-text">vCue Hub</h3>
            <p class="loading-subtext">Loading your dashboard...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card scale-in">
            <div class="flex items-center justify-center gap-2 mb-6">
                <img src="assets/logo.jpg" alt="VisionaryCue" style="height: 48px;">
                <h1 class="text-4xl font-bold text-white">vCue Hub</h1>
            </div>
            <p class="login-subtitle">Secure login to access your CRM dashboard</p>

            <div id="login-step-email" class="login-step">
                <h2 class="login-step-title">Enter Email</h2>
                <p class="login-step-desc">Use your registered work email and click Proceed.</p>
                <div class="password-input-wrap">
                    <input type="email" id="login-email-input" class="password-input" placeholder="name@vcuehub.com"
                        onkeypress="if(event.key==='Enter') handleEmailProceed()">
                </div>
                <p id="login-email-error" class="password-error-message" aria-live="polite"></p>
                <button class="password-signin-btn" onclick="handleEmailProceed()">
                    <i class="fas fa-arrow-right"></i>Proceed
                </button>
            </div>

            <div id="login-step-password" class="login-step hidden">
                <h2 class="login-step-title">Welcome Back, <span id="login-welcome-name">User</span></h2>
                <p class="login-step-desc">Enter password and sign in.</p>
                <div class="password-user-avatar">
                    <img id="password-user-avatar" src="assets/logo.jpg" alt="User profile">
                </div>
                <div id="password-user-name" class="password-user-name">User Name</div>
                <p id="password-user-designation" class="password-user-designation">Team Member</p>

                <div class="password-input-wrap">
                    <input type="password" id="password-input" class="password-input" placeholder="Enter password"
                        onkeypress="if(event.key==='Enter') verifyPassword()">
                    <button type="button" id="password-toggle-btn" class="password-toggle-btn"
                        onclick="togglePasswordVisibility()" aria-label="Toggle password visibility">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <p id="password-error-message" class="password-error-message" aria-live="polite"></p>

                <button class="password-signin-btn" onclick="verifyPassword()">
                    <i class="fas fa-arrow-right-to-bracket"></i>Sign In
                </button>
                <button class="login-back-btn" onclick="backToEmailStep()">Use different email</button>
            </div>
        </div>
        <!-- Footer with support email -->
        <div class="login-footer">
            <i class="fas fa-envelope"></i>
            <span>Need help? Contact us at </span>
            <a href="mailto:Support@vcuehub.com">Support@vcuehub.com</a>
        </div>
    </div>

    <!-- Lead Detail Popup with Timeline - Modern Redesign -->
    <div id="lead-popup" class="modal-overlay">
        <div class="modal-content modern-modal">

            <!-- Header -->
            <div class="modal-header">
                <div class="header-left">
                    <div class="header-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div>
                        <h2>Lead Details</h2>
                        <p class="lead-id">ID: #LD-2026-021</p>
                    </div>
                </div>
                <button class="modal-close-btn"
                    onclick="document.getElementById('lead-popup').classList.remove('active')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Scrollable Body -->
            <div class="modal-body">

                <!-- Lead Info -->
                <div class="lead-info-grid" id="popup-lead-details"></div>

                <!-- Timeline -->
                <div class="timeline-section">
                    <div class="timeline-header">
                        <div class="timeline-title">
                            <i class="fas fa-history"></i>
                            <h3>Remark Timeline</h3>
                        </div>
                        <span class="timeline-count" id="timeline-count">3 entries</span>
                    </div>

                    <div id="popup-remark-container" class="timeline-container"></div>
                    <div class="remark-editor">
                        <label for="popup-remark-input" class="remark-editor-label">Add / Update Remark</label>
                        <textarea id="popup-remark-input" class="remark-editor-input"
                            placeholder="Type remark update..."></textarea>
                        <div class="remark-editor-actions">
                            <button type="button" class="btn btn-secondary" onclick="addRemarkEntry()">
                                <i class="fas fa-plus mr-2"></i>Add Remark
                            </button>
                            <button type="button" class="btn btn-primary" onclick="updateSelectedRemark()">
                                <i class="fas fa-pen mr-2"></i>Update Remark
                            </button>
                        </div>
                        <p id="remark-editor-hint" class="remark-editor-hint">Click any timeline item to edit that
                            specific remark.</p>
                    </div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="modal-actions">
                <button class="btn-action btn-secondary"
                    onclick="document.getElementById('lead-popup').classList.remove('active')">
                    Close
                </button>
                <button class="btn-action btn-primary" onclick="editLead()">
                    Edit Lead
                </button>
            </div>

        </div>
    </div>

    <!-- Lead Add/Edit Modal -->
    <div id="lead-form-modal" class="modal-overlay">
        <div class="modal-content lead-form-modal-card">
            <div class="lead-form-header">
                <h2 id="lead-form-title" class="text-2xl font-bold text-white">Add Lead</h2>
                <button class="modal-close-btn" onclick="closeLeadFormModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="lead-form" onsubmit="saveLeadDetails(event)">
                <div class="lead-form-body">
                    <div class="lead-form-grid">
                        <div class="lead-form-field">
                            <label for="lead-form-name">Name</label>
                            <input id="lead-form-name" type="text" class="input-field" required>
                        </div>
                        <div class="lead-form-field">
                            <label for="lead-form-email">Email</label>
                            <input id="lead-form-email" type="email" class="input-field" placeholder="name@example.com">
                        </div>
                        <div class="lead-form-field">
                            <label for="lead-form-phone">Phone</label>
                            <input id="lead-form-phone" type="text" class="input-field" required>
                        </div>
                        <div class="lead-form-field">
                            <label for="lead-form-source">Source</label>
                            <input id="lead-form-source" type="text" class="input-field"
                                placeholder="Website, Instagram, Referral...">
                        </div>
                        <div class="lead-form-field">
                            <label for="lead-form-budget">Budget</label>
                            <input id="lead-form-budget" type="text" class="input-field" placeholder="₹0">
                        </div>
                        <div class="lead-form-field">
                            <label for="lead-form-owner">Lead Owner</label>
                            <input id="lead-form-owner" type="text" class="input-field">
                        </div>
                        <div class="lead-form-field">
                            <label for="lead-form-stage">Stage</label>
                            <select id="lead-form-stage" class="input-field">
                                <option value="New">New</option>
                                <option value="Hot">Hot</option>
                                <option value="Warm">Warm</option>
                                <option value="Cold">Cold</option>
                            </select>
                        </div>
                        <div class="lead-form-field">
                            <label for="lead-form-date">Date Added</label>
                            <input id="lead-form-date" type="date" class="input-field">
                        </div>
                    </div>
                    <div class="lead-form-field">
                        <label for="lead-form-remark">Remark</label>
                        <textarea id="lead-form-remark" class="input-field lead-form-remark"
                            placeholder="Add remark timeline notes..."></textarea>
                    </div>
                </div>
                <div class="lead-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeLeadFormModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="lead-form-submit-btn"><i
                            class="fas fa-save mr-2"></i>Save Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Self Profile Settings Modal -->
    <div id="self-profile-modal" class="modal-overlay">
        <div class="modal-content user-modal-card profile-settings-card">
            <div class="lead-form-header">
                <h2 class="text-2xl font-bold text-white">Profile Settings</h2>
                <button class="modal-close-btn" onclick="closeSelfProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="self-profile-form" onsubmit="saveSelfProfile(event)">
                <div class="user-modal-body">
                    <div class="profile-picture-preview-wrap">
                        <img id="self-profile-picture-preview" src="assets/logo.jpg" alt="Profile Preview"
                            class="profile-picture-preview">
                        <div>
                            <p class="text-sm font-semibold text-white">Profile Preview</p>
                            <p class="text-xs text-gray-400">Update your display details below.</p>
                        </div>
                    </div>
                    <div class="user-modal-grid">
                        <div class="lead-form-field">
                            <label for="self-profile-display-name">Display Name</label>
                            <input id="self-profile-display-name" type="text" class="input-field" required>
                        </div>
                        <div class="lead-form-field">
                            <label for="self-profile-email">Email</label>
                            <input id="self-profile-email" type="email" class="input-field" required>
                            <p id="self-profile-email-note" class="profile-email-note"></p>
                        </div>
                        <div class="lead-form-field">
                            <label for="self-profile-password">Password</label>
                            <input id="self-profile-password" type="text" class="input-field" required>
                        </div>
                        <div class="lead-form-field">
                            <label for="self-profile-picture">Profile Image Path</label>
                            <input id="self-profile-picture" type="text" class="input-field"
                                placeholder="assets/profiles/user.jpg" oninput="updateSelfProfilePicturePreview()">
                        </div>
                    </div>
                </div>
                <div class="lead-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSelfProfileModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin User Management Modal -->
    <div id="user-management-modal" class="modal-overlay">
        <div class="modal-content user-modal-card">
            <div class="lead-form-header">
                <h2 id="user-management-title" class="text-2xl font-bold text-white">Add User</h2>
                <button class="modal-close-btn" onclick="closeUserManagementModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="user-management-form" onsubmit="saveUserFromAdmin(event)">
                <input type="hidden" id="user-form-original-name">
                <div class="user-modal-body">
                    <div class="user-modal-grid">
                        <div class="lead-form-field">
                            <label for="user-form-name">Full Name</label>
                            <input id="user-form-name" type="text" class="input-field" required>
                        </div>
                        <div class="lead-form-field">
                            <label for="user-form-email">Email</label>
                            <input id="user-form-email" type="email" class="input-field" required>
                        </div>
                        <div class="lead-form-field">
                            <label for="user-form-password">Password</label>
                            <input id="user-form-password" type="text" class="input-field" required>
                        </div>
                        <div class="lead-form-field">
                            <label for="user-form-role">Assigned Role</label>
                            <select id="user-form-role" class="input-field" onchange="handleUserRoleChangeForAccess()">
                                <option value="Admin">Admin</option>
                                <option value="Team Member">Team Member</option>
                            </select>
                        </div>
                        <div class="lead-form-field">
                            <label for="user-form-designation">Designation</label>
                            <input id="user-form-designation" type="text" class="input-field"
                                placeholder="Manager, Executive...">
                        </div>
                        <div class="lead-form-field">
                            <label for="user-form-profile">Profile Image Path (optional)</label>
                            <input id="user-form-profile" type="text" class="input-field"
                                placeholder="assets/profiles/user.jpg">
                        </div>
                    </div>
                    <div class="lead-form-field mt-2">
                        <label>Dashboard Feature Access</label>
                        <div id="feature-access-grid" class="feature-access-grid"></div>
                        <p class="feature-access-legend">Only checked features will be visible and accessible for this
                            user.</p>
                    </div>
                </div>
                <div class="lead-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUserManagementModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="user-management-submit-btn"><i
                            class="fas fa-save mr-2"></i>Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar (reordered: vCue Store after Career Counselling, before G Meet) -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="assets/logo.jpg" alt="VisionaryCue">
            <h2>vCue Hub</h2>
        </div>
        <!-- New Home item – will be hidden for non‑admin -->
        <div class="nav-item" id="nav-home" onclick="showHomeAnalytics()"><i class="fas fa-home"></i><span>Home</span>
        </div>
        <div class="nav-item nav-accordion" id="nav-leads-toggle" onclick="toggleLeadsMenu()">
            <div class="nav-item-label"><i class="fas fa-address-book"></i><span>Leads</span></div>
            <i class="fas fa-chevron-down nav-accordion-icon"></i>
        </div>
        <div class="leads-submenu" id="leads-submenu">
            <div class="nav-sub-item" id="nav-leads-digital" onclick="selectDepartment('digital')"><i
                    class="fas fa-mobile-alt"></i><span>Digital Sales</span></div>
            <div class="nav-sub-item" id="nav-leads-abroad" onclick="selectDepartment('abroad')"><i
                    class="fas fa-globe-asia"></i><span>Study Abroad</span></div>
            <div class="nav-sub-item" id="nav-leads-domestic" onclick="selectDepartment('domestic')"><i
                    class="fas fa-home"></i><span>Career Counseling</span></div>
            <div class="nav-sub-item" id="nav-leads-store" onclick="showStore()"><i class="fas fa-store"></i><span>vCue
                    Store</span></div>
        </div>
        <div class="nav-item" id="nav-gmeet" onclick="showGMeet()"><i class="fas fa-video"></i><span>G Meet
                Status</span></div>
        <div class="nav-item" id="nav-pipeline" onclick="showPipeline()"><i
                class="fas fa-chart-line"></i><span>Pipeline</span></div>
        <div class="nav-item" id="nav-vcue-connect" onclick="showVCueConnect()"><i
                class="fab fa-whatsapp"></i><span>vCue Connect</span></div>

        <!-- ***** REPLACED Meta Ads with Meta Integration (Admin Only) ***** -->
        <div class="nav-item" id="nav-meta" onclick="showMetaIntegration()"><i class="fab fa-facebook"></i><span>Meta
                Integration</span></div>
        <div class="nav-item" id="nav-user-management" onclick="showUserManagementSection()"><i
                class="fas fa-users"></i><span>User Management</span></div>

        <div class="admin-info">
            <button type="button" class="sidebar-profile-trigger" onclick="openSelfProfileModal()">
                <div id="sidebar-role-label" class="text-xs text-gray-400 mb-2"></div>
                <div id="current-user-display" class="font-medium text-white mb-1"></div>
                <div id="current-role-display" class="text-xs text-gray-500"></div>
                <div class="sidebar-profile-edit-note"><i class="fas fa-user-edit mr-1"></i>Profile Settings</div>
            </button>
            <button onclick="logout()" class="mt-3 text-sm text-red-400 hover:text-red-300"><i
                    class="fas fa-sign-out-alt mr-1"></i> Logout</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <!-- Department selection overlay (only for admin) -->
        <div id="dept-select-screen">
            <div class="dept-select-card scale-in">
                <h2 class="text-3xl font-bold text-white mb-3">Welcome, <span id="welcome-user">Admin</span> 👋</h2>
                <p class="text-gray-400 text-lg mb-12">Which department would you like to access?</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="dept-option" onclick="selectDepartment('digital')">
                        <i class="fas fa-mobile-alt text-blue-400"></i>
                        <h3 class="text-white">Digital Sales</h3>
                        <p>Online campaigns & leads</p>
                    </div>
                    <div class="dept-option" onclick="selectDepartment('abroad')">
                        <i class="fas fa-globe-asia text-green-400"></i>
                        <h3 class="text-white">Study Abroad</h3>
                        <p>International students</p>
                    </div>
                    <div class="dept-option" onclick="selectDepartment('domestic')">
                        <i class="fas fa-home text-yellow-400"></i>
                        <h3 class="text-white">Career Counselling</h3>
                        <p>Local programs & coaching</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ***** NEW META INTEGRATION PANE (Admin only) ***** -->
        <div id="meta-integration-pane" class="hidden-pane">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-white">Meta Integration</h1>
                    <p class="text-gray-400 text-sm mt-1">Facebook & Instagram tools for admins</p>
                </div>
            </div>

            <!-- Feature Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- 1. Fresh Leads Capture -->
                <div class="bg-[#1a2332] rounded-2xl p-6 border border-gray-800 hover:border-blue-500 transition-all">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-blue-600/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-cloud-download-alt text-2xl text-blue-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white">Fresh Leads Capture</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Automatically pull new leads from Meta Lead Forms into CRM.
                    </p>
                    <div class="flex gap-2">
                        <button class="btn btn-primary text-sm py-2" onclick="captureFreshLeads()">
                            <i class="fas fa-sync-alt mr-1"></i>Sync Now
                        </button>
                        <span class="text-xs text-green-400 self-center" id="fresh-leads-status">Idle</span>
                    </div>
                </div>

                <!-- 2. Meta Ads Performance -->
                <div class="bg-[#1a2332] rounded-2xl p-6 border border-gray-800 hover:border-blue-500 transition-all">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-green-600/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-2xl text-green-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white">Meta Ads Performance</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Impressions, clicks, spend, CPC, CTR from last 30 days.</p>
                    <button class="btn btn-primary text-sm py-2" onclick="showAdsPerformance()">
                        <i class="fas fa-chart-bar mr-1"></i>View Report
                    </button>
                    <!-- mini summary (will be updated via JS) -->
                    <div id="ads-mini-summary" class="mt-3 text-xs text-gray-400"></div>
                </div>

                <!-- 3. Custom Audience from CRM -->
                <div class="bg-[#1a2332] rounded-2xl p-6 border border-gray-800 hover:border-blue-500 transition-all">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-purple-600/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-2xl text-purple-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white">Custom Audience</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Create audiences from CRM data (Hot, Warm, Cold leads).</p>
                    <select id="audience-segment" class="input-field text-sm py-2 mb-2">
                        <option value="hot">Hot Leads</option>
                        <option value="warm">Warm Leads</option>
                        <option value="cold">Cold Leads</option>
                        <option value="all">All Digital Sales</option>
                        <option value="store">Store Inquiries</option>
                    </select>
                    <div class="flex gap-2">
                        <input type="text" id="audience-name" placeholder="Audience name"
                            class="input-field text-sm py-2 flex-1">
                        <button class="btn btn-primary text-sm py-2" onclick="createCustomAudience()">Create</button>
                    </div>
                    <div id="audience-status" class="mt-2 text-xs hidden"></div>
                </div>
            </div>

            <!-- Hidden Ads detail table (shown when user clicks "View Report") -->
            <div id="ads-performance-detail" class="hidden mt-6">
                <div class="filter-bar">
                    <div class="date-wrapper">
                        <label for="meta-date-from"><i class="far fa-calendar-alt mr-1"></i>From:</label>
                        <input type="date" id="meta-date-from">
                    </div>
                    <div class="date-wrapper">
                        <label for="meta-date-to"><i class="far fa-calendar-alt mr-1"></i>To:</label>
                        <input type="date" id="meta-date-to">
                    </div>
                    <button class="btn btn-primary" onclick="applyMetaDateFilter()">Apply</button>
                    <button class="clear-btn" onclick="resetMetaDateFilter()">Reset to Last 30 Days</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="meta-ads-summary"></div>
                <div class="table-container">
                    <table id="meta-ads-table">
                        <thead>
                            <tr>
                                <th>Campaign</th>
                                <th>Impressions</th>
                                <th>Clicks</th>
                                <th>Spend (₹)</th>
                                <th>CPC (₹)</th>
                                <th>CTR (%)</th>
                                <th>Date Range</th>
                            </tr>
                        </thead>
                        <tbody id="meta-ads-table-body">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">Click "View Report" to load data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- vCue Connect Pane (Custom Cloud WABA API Integration) -->
        <div id="vcue-connect-pane" class="hidden-pane">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-white">vCue Connect</h1>
                    <p class="text-gray-400 text-sm mt-1"><i class="fab fa-whatsapp mr-1"></i>Custom Cloud WABA API
                        Integration</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-[#1a2332] rounded-2xl p-6 border border-gray-800 hover:border-green-500 transition-all">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-green-600/20 rounded-xl flex items-center justify-center">
                            <i class="fab fa-whatsapp text-2xl text-green-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white">WABA Status</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Monitor WhatsApp Business API connectivity for vCue Connect.
                    </p>
                    <div class="flex items-center gap-3">
                        <button class="btn btn-primary text-sm py-2" onclick="refreshWabaStatus()">
                            <i class="fas fa-sync-alt mr-1"></i>Check Status
                        </button>
                        <span id="waba-status-indicator" class="text-xs text-gray-400">Not checked</span>
                    </div>
                </div>

                <div class="bg-[#1a2332] rounded-2xl p-6 border border-gray-800 hover:border-green-500 transition-all">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-emerald-600/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-paper-plane text-2xl text-emerald-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white">Send Test Message</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Validate template/message delivery through Cloud WABA API.</p>
                    <input id="waba-test-phone" type="text" class="input-field text-sm py-2 mb-2"
                        placeholder="Recipient number (with country code)">
                    <button class="btn btn-primary text-sm py-2" onclick="sendWabaTestMessage()">
                        <i class="fas fa-paper-plane mr-1"></i>Send Test
                    </button>
                </div>

                <div class="bg-[#1a2332] rounded-2xl p-6 border border-gray-800 hover:border-green-500 transition-all">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-lime-600/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-plug text-2xl text-lime-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white">Webhook Health</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Track incoming webhook events from vCue Connect endpoints.</p>
                    <button class="btn btn-secondary text-sm py-2" onclick="loadWabaWebhookHealth()">
                        <i class="fas fa-server mr-1"></i>Check Webhooks
                    </button>
                    <div id="waba-webhook-status" class="mt-3 text-xs text-gray-400">Waiting for check...</div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Event</th>
                            <th>Status</th>
                            <th>Reference</th>
                        </tr>
                    </thead>
                    <tbody id="waba-events-body">
                        <tr>
                            <td colspan="4" class="text-center py-8 text-gray-500">No webhook events loaded</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Department Dashboard (for digital/abroad/domestic) -->
        <div id="department-dashboard" class="hidden-pane">
            <div class="flex justify-between items-start md:items-center gap-3 mb-4 flex-wrap">
                <div>
                    <h1 id="dept-dashboard-title" class="text-3xl font-bold text-white">Loading...</h1>
                    <p class="text-gray-400 text-sm mt-1"><i class="fas fa-database mr-1"></i> Connected to MySQL
                        Backend</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="openAddLeadModal()" class="btn btn-secondary"><i class="fas fa-plus mr-2"></i>Add
                        Leads</button>
                    <button onclick="triggerLeadCsvImport()" class="btn btn-secondary"><i
                            class="fas fa-file-csv mr-2"></i>Import Data via CSV</button>
                    <button onclick="exportToExcel()" class="btn btn-primary"><i
                            class="fas fa-download mr-2"></i>Export</button>
                </div>
            </div>
            <input type="file" id="lead-csv-input" class="hidden" accept=".csv,text/csv"
                onchange="handleLeadCsvImport(event)">

            <div class="filter-bar">
                <div class="search-wrapper">
                    <i class="fas fa-search mr-2"></i>
                    <input type="text" id="searchInput" placeholder="Search by name, phone or email..."
                        onkeyup="applyFilters()">
                </div>
                <div class="date-wrapper">
                    <label for="dateFilter"><i class="far fa-calendar-alt mr-1"></i>Added after:</label>
                    <input type="date" id="dateFilter" onchange="applyFilters()">
                </div>
                <button class="clear-btn" onclick="clearFilters()"><i class="fas fa-times mr-1"></i>Clear all</button>
            </div>

            <div id="active-filter-chip" class="mb-3 text-sm"></div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="dept-stats"></div>

            <div class="table-container" id="table-container">
                <table id="leads-table">
                    <colgroup>
                        <col class="col-name">
                        <col class="col-email">
                        <col class="col-phone">
                        <col class="col-source">
                        <col class="col-budget">
                        <col class="col-owner">
                        <col class="col-stage">
                        <col class="col-remark">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th id="source-th" class="filterable-th" onclick="toggleDropdown('source')">Source <i
                                    class="fas fa-chevron-down"></i></th>
                            <th>Budget</th>
                            <th id="owner-th" class="filterable-th" onclick="toggleDropdown('owner')">Lead Owner <i
                                    class="fas fa-chevron-down"></i></th>
                            <th id="stage-th" class="filterable-th" onclick="toggleDropdown('stage')">Stage <i
                                    class="fas fa-chevron-down"></i></th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="dept-table-body"></tbody>
                </table>

                <!-- Dropdown menus -->
                <div id="source-dropdown" class="filter-dropdown"></div>
                <div id="owner-dropdown" class="filter-dropdown"></div>
                <div id="stage-dropdown" class="filter-dropdown"></div>
            </div>
        </div>

        <!-- G Meet Status Pane (with owner filter and department filter) -->
        <div id="gmeet-pane" class="hidden-pane">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-white">G Meet Status</h1>
                    <p class="text-gray-400 text-sm mt-1">Track all Google Meet sessions</p>
                </div>
            </div>
            <!-- Filter bar with two dropdowns -->
            <div class="gmeet-filter-bar">
                <i class="fas fa-filter text-blue-400"></i>
                <select id="gmeetOwnerFilter" class="owner-filter-select" onchange="filterGMeets()">
                    <option value="All">All Owners</option>
                </select>
                <select id="gmeetDeptFilter" class="owner-filter-select" onchange="filterGMeets()">
                    <option value="All">All Departments</option>
                </select>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Lead Owner</th>
                            <th>Department</th> <!-- new column -->
                            <th>Lead Name</th>
                            <th>G Meet Date</th>
                            <th>Agenda</th>
                            <th>Outcome</th>
                            <th>Proposal Shared</th>
                            <th>Amount Pitched</th>
                        </tr>
                    </thead>
                    <tbody id="gmeet-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Pipeline Pane -->
        <div id="pipeline-pane" class="hidden-pane">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-white">Pipeline Overview</h1>
                    <p class="text-gray-400 text-sm mt-1">Based on "Amount Pitched" in G Meet</p>
                </div>
            </div>

            <div class="pipeline-total-card" id="pipeline-total-container">
                <div class="text-gray-400 text-sm mb-1">Total Pipeline Value</div>
                <div class="amount-display" id="total-pipeline-amount">₹0</div>
                <div class="text-gray-500 text-xs mt-2">from all G Meet opportunities</div>
            </div>

            <h2 class="text-xl font-semibold text-white mb-4">Pipeline by Lead Owner</h2>
            <div class="pipeline-grid" id="pipeline-owner-grid"></div>

            <div class="mt-10">
                <h3 class="text-lg font-medium text-white mb-3">Detailed Pitched Meetings</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Lead Owner</th>
                                <th>Lead Name</th>
                                <th>Amount Pitched</th>
                                <th>Date</th>
                                <th>Outcome</th>
                            </tr>
                        </thead>
                        <tbody id="pipeline-detail-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- vCue Store Dashboard (new) -->
        <div id="store-dashboard" class="hidden-pane">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">vCue Store Leads</h1>
                    <p class="text-gray-400 text-sm mt-1"><i class="fas fa-store mr-1"></i> VCue Store Inquiries</p>
                </div>
                <button onclick="exportStoreToExcel()" class="btn btn-primary"><i
                        class="fas fa-download mr-2"></i>Export</button>
            </div>

            <div class="filter-bar">
                <div class="search-wrapper">
                    <i class="fas fa-search mr-2"></i>
                    <input type="text" id="storeSearchInput" placeholder="Search store leads..."
                        onkeyup="applyStoreFilters()">
                </div>
                <div class="date-wrapper">
                    <label for="storeDateFilter"><i class="far fa-calendar-alt mr-1"></i>Added after:</label>
                    <input type="date" id="storeDateFilter" onchange="applyStoreFilters()">
                </div>
                <button class="clear-btn" onclick="clearStoreFilters()"><i class="fas fa-times mr-1"></i>Clear
                    all</button>
            </div>

            <div id="store-active-filter-chip" class="mb-3 text-sm"></div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="store-stats"></div>

            <div class="table-container">
                <table id="store-table">
                    <colgroup>
                        <col class="col-name">
                        <col class="col-email">
                        <col class="col-phone">
                        <col class="col-source">
                        <col class="col-budget">
                        <col class="col-owner">
                        <col class="col-stage">
                        <col class="col-remark">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Source</th>
                            <th>Budget</th>
                            <th>Lead Owner</th>
                            <th>Stage</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="store-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- New Home Analytics Pane (only for Admin) -->
        <div id="home-analytics" class="hidden-pane">
            <div class="mb-6">
                <p id="home-current-date" class="text-gray-400 text-sm">Monday, February 23, 2026</p>
                <h1 class="text-3xl font-bold text-white mt-2">Greetings, <span id="home-greeting-user">User</span></h1>
            </div>
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-white">Analytics</h2>
                    <p class="text-gray-400 text-sm mt-1">Overview of all team members</p>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="home-summary-stats"></div>

            <!-- Per‑User Table -->
            <div class="table-container">
                <table id="home-analytics-table">
                    <thead>
                        <tr>
                            <th>Lead Owner</th>
                            <th>Total Leads</th>
                            <th>Hot</th>
                            <th>Warm</th>
                            <th>Cold</th>
                            <th>Pipeline Value</th>
                            <th>G Meets</th>
                        </tr>
                    </thead>
                    <tbody id="home-table-body"></tbody>
                </table>
            </div>

        </div>

        <div id="user-management-pane" class="hidden-pane">
            <div class="user-admin-header">
                <div>
                    <h1 class="text-3xl font-bold text-white">User Management</h1>
                    <p class="text-gray-400 text-sm mt-1">Add users, remove users, edit roles, and configure dashboard
                        feature access.</p>
                </div>
                <button class="btn btn-primary" onclick="openUserManagementModal('add')"><i
                        class="fas fa-user-plus mr-2"></i>Add User</button>
            </div>
            <div class="table-container">
                <table id="user-management-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Designation</th>
                            <th>Feature Access</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-management-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        //==================== CONFIGURATION ====================
        const API_BASE_URL = 'https://vcue-crm-api.onrender.com';
        const API_ENDPOINTS = {
            leads: '/api/leads',
            storeLeads: '/api/store-leads',
            gmeetMeetings: '/api/gmeet-meetings',
            leadById: (leadId) => `/api/leads/${encodeURIComponent(leadId)}`,
            importLeadsCsv: '/api/leads/import-csv'
        };

        // User credentials and access configuration
        const FEATURE_ACCESS_CONFIG = [
            { key: 'home', label: 'Home Analytics' },
            { key: 'digital', label: 'Digital Sales Leads' },
            { key: 'abroad', label: 'Study Abroad Leads' },
            { key: 'domestic', label: 'Career Counselling Leads' },
            { key: 'store', label: 'vCue Store' },
            { key: 'gmeet', label: 'G Meet Status' },
            { key: 'pipeline', label: 'Pipeline' },
            { key: 'vcueconnect', label: 'vCue Connect (WABA)' },
            { key: 'meta', label: 'Meta Integration' }
        ];
        const USER_STORAGE_KEY = 'vcuehub_users_v2';

        function createDefaultFeatureAccess(role = 'Team Member') {
            if (role === 'Admin') {
                return {
                    home: true, digital: true, abroad: true, domestic: true, store: true,
                    gmeet: true, pipeline: true, vcueconnect: true, meta: true
                };
            }
            return {
                home: false, digital: true, abroad: false, domestic: false, store: true,
                gmeet: true, pipeline: true, vcueconnect: true, meta: false
            };
        }

        function normalizeFeatureAccess(rawAccess, role) {
            const defaults = createDefaultFeatureAccess(role);
            const normalized = { ...defaults };
            if (rawAccess && typeof rawAccess === 'object') {
                FEATURE_ACCESS_CONFIG.forEach((feature) => {
                    if (rawAccess[feature.key] !== undefined) {
                        normalized[feature.key] = Boolean(rawAccess[feature.key]);
                    }
                });
            }
            if (!Object.values(normalized).some(Boolean)) {
                if (role === 'Admin') normalized.home = true;
                else normalized.digital = true;
            }
            if (role === 'Admin') normalized.home = true;
            else normalized.home = false;
            return normalized;
        }

        function normalizeUserRecord(name, userData = {}) {
            const role = userData.role === 'Admin' ? 'Admin' : 'Team Member';
            return {
                password: String(userData.password || '').trim() || 'changeme123',
                role,
                email: String(userData.email || '').trim().toLowerCase(),
                designation: String(userData.designation || role).trim(),
                profilePic: String(userData.profilePic || 'assets/logo.jpg').trim(),
                featureAccess: normalizeFeatureAccess(userData.featureAccess, role)
            };
        }

        function persistUsers() {
            try {
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(USERS));
            } catch (error) {
                console.error('Unable to persist users:', error);
            }
        }

        const DEFAULT_USERS = {
            'Ankur Mishra': {
                password: 'ankur123',
                role: 'Admin',
                email: 'ankur@vcuehub.com',
                designation: 'Co-Founder',
                profilePic: 'assets/profiles/ankur.jpg',
                featureAccess: createDefaultFeatureAccess('Admin')
            },
            'Sarthak': {
                password: 'sarthak123',
                role: 'Team Member',
                email: 'sarthak@vcuehub.com',
                designation: 'Digital Sales Executive',
                profilePic: 'assets/profiles/sarthak.jpg',
                featureAccess: createDefaultFeatureAccess('Team Member')
            },
            'Aabid': {
                password: 'aabid123',
                role: 'Team Member',
                email: 'aabid@vcuehub.com',
                designation: 'Digital Sales Executive',
                profilePic: 'assets/profiles/aabid.jpg',
                featureAccess: createDefaultFeatureAccess('Team Member')
            },
            'Shivam Madaan': {
                password: 'shivam123',
                role: 'Team Member',
                email: 'shivam@vcuehub.com',
                designation: 'Head - Digital Sales',
                profilePic: 'assets/profiles/shivam.jpg',
                featureAccess: createDefaultFeatureAccess('Team Member')
            },
            'Divyansh Gupta': {
                password: 'divyansh123',
                role: 'Admin',
                email: 'divyansh@vcuehub.com',
                designation: 'Founder & CEO',
                profilePic: 'assets/profiles/divyansh.png',
                featureAccess: createDefaultFeatureAccess('Admin')
            }
        };

        function loadUsersFromStorage() {
            let parsed = null;
            try {
                parsed = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || 'null');
            } catch (error) {
                parsed = null;
            }
            const source = parsed && typeof parsed === 'object' ? parsed : DEFAULT_USERS;
            const normalized = {};
            Object.entries(source).forEach(([name, user]) => {
                normalized[name] = normalizeUserRecord(name, user);
            });
            return normalized;
        }

        let USERS = loadUsersFromStorage();
        persistUsers();

        let currentUser = null, currentRole = null;
        let leads = [];               // all department leads
        let storeLeads = [];          // store leads
        let gmeetMeetings = [];       // all G Meet entries
        let activeDepartment = null;
        let selectedLeadId = null;
        let activePopupLead = null;
        let leadFormMode = 'add';
        let activeRemarkIndex = null;
        let activeTimelineEntries = [];

        // Filter state for dept dashboard
        let searchTerm = '';
        let filterDate = null;
        let columnFilters = { owner: null, source: null, stage: null };
        let openDropdown = null;

        // Filter state for store dashboard
        let storeSearchTerm = '';
        let storeFilterDate = null;

        // Sample fallback data (updated with department for GMeet)
        const sampleLeads = [
            {
                name: 'Rahul Verma', email: 'rahul@email.com', phone: '9812345678', source: 'Instagram', budget: '₹50,000', owner: 'Ankur Mishra', stage: 'Hot',
                remark: `12 feb\nright now occupied and wants to connect on 14 feb at 11 am..\nfeb 16 right now travelling so wants to connect after 1 week`, department: 'digital', dateAdded: '2025-02-12'
            },
            {
                name: 'Priya Singh', email: 'priya@email.com', phone: '8822334455', source: 'LinkedIn', budget: '₹25,000', owner: 'Sarthak', stage: 'Warm',
                remark: `Called twice, no response. Will try again Monday.`, department: 'digital', dateAdded: '2025-02-10'
            },
            {
                name: 'John Doe', email: 'john@email.com', phone: '7766554433', source: 'Website', budget: '₹1,00,000', owner: 'Aabid', stage: 'Hot',
                remark: `Interested in contract, asked for detailed proposal by Friday.`, department: 'domestic', dateAdded: '2025-02-14'
            },
            {
                name: 'Alex Kumar', email: 'alex@email.com', phone: '9988776655', source: 'Referral', budget: '₹15,000', owner: 'Shivam Madaan', stage: 'Cold',
                remark: `Not interested right now – call back in Q2.`, department: 'abroad', dateAdded: '2025-02-01'
            },
            {
                name: 'Neha Sharma', email: 'neha@email.com', phone: '8877665544', source: 'Facebook', budget: '₹75,000', owner: 'Shivam Madaan', stage: 'Warm',
                remark: `Follow up next week.`, department: 'digital', dateAdded: '2025-02-18'
            }
        ];
        const sampleStoreLeads = [
            { name: 'Rohit Mehra', email: 'rohit@email.com', phone: '9988771122', source: 'Website', budget: '₹12,000', owner: 'Ankur Mishra', stage: 'Warm', remark: 'Interested in product X', dateAdded: '2025-02-20' },
            { name: 'Anjali Gupta', email: 'anjali@email.com', phone: '9876543210', source: 'Instagram', budget: '₹8,500', owner: 'Sarthak', stage: 'Hot', remark: 'Asked for demo', dateAdded: '2025-02-19' },
            { name: 'Vikram Singh', email: 'vikram@email.com', phone: '8765432109', source: 'Referral', budget: '₹22,000', owner: 'Shivam Madaan', stage: 'Cold', remark: 'Not now', dateAdded: '2025-02-18' }
        ];
        const sampleGMeets = [
            { leadOwner: 'Ankur Mishra', leadName: 'Rahul Verma', meetDate: '2025-02-25 11:00 AM', agenda: 'SEO Discussion', outcome: 'Interested', proposalShared: 'Yes', amountPitched: '₹50,000', department: 'Digital Sales' },
            { leadOwner: 'Sarthak', leadName: 'Priya Singh', meetDate: '2025-02-26 03:00 PM', agenda: 'Social Media', outcome: 'Decide next week', proposalShared: 'No', amountPitched: '₹25,000', department: 'Digital Sales' },
            { leadOwner: 'Aabid', leadName: 'John Doe', meetDate: '2025-02-27 02:00 PM', agenda: 'Contract', outcome: 'Agreed', proposalShared: 'Yes', amountPitched: '₹1,00,000', department: 'Career Counselling' },
            { leadOwner: 'Shivam Madaan', leadName: 'Neha Sharma', meetDate: '2025-02-28 10:00 AM', agenda: 'Product Demo', outcome: 'Positive', proposalShared: 'Yes', amountPitched: '₹75,000', department: 'Digital Sales' }
        ];

        // Helper functions
        function showToast(msg, err) {
            const t = document.getElementById('toast'), m = document.getElementById('toast-message');
            m.textContent = msg; t.style.borderLeftColor = err ? '#ef4444' : '#3b82f6';
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Login flow handling
        let selectedUser = null, selectedRole = null, selectedDesignation = '';

        function clearPasswordError() {
            const input = document.getElementById('password-input');
            const wrap = document.getElementById('login-step-password')?.querySelector('.password-input-wrap');
            const err = document.getElementById('password-error-message');
            if (!input || !wrap || !err) return;
            input.classList.remove('error');
            wrap.classList.remove('shake');
            err.textContent = '';
            err.classList.remove('show');
        }

        function showPasswordError(message) {
            const input = document.getElementById('password-input');
            const wrap = document.getElementById('login-step-password')?.querySelector('.password-input-wrap');
            const err = document.getElementById('password-error-message');
            if (!input || !wrap || !err) return;
            input.classList.add('error');
            err.textContent = message;
            err.classList.add('show');
            wrap.classList.remove('shake');
            void wrap.offsetWidth;
            wrap.classList.add('shake');
        }

        function clearEmailError() {
            const input = document.getElementById('login-email-input');
            const err = document.getElementById('login-email-error');
            if (!input || !err) return;
            input.classList.remove('error');
            err.textContent = '';
            err.classList.remove('show');
        }

        function showEmailError(message) {
            const input = document.getElementById('login-email-input');
            const err = document.getElementById('login-email-error');
            if (!input || !err) return;
            input.classList.add('error');
            err.textContent = message;
            err.classList.add('show');
        }

        function normalizeEmail(value) {
            return String(value || '').trim().toLowerCase();
        }

        function getUserByEmail(email) {
            const normalized = normalizeEmail(email);
            for (const [userName, userData] of Object.entries(USERS)) {
                if (normalizeEmail(userData.email) === normalized) {
                    return { userName, userData };
                }
            }
            return null;
        }

        function setLoginStep(step) {
            const emailStep = document.getElementById('login-step-email');
            const passwordStep = document.getElementById('login-step-password');
            if (!emailStep || !passwordStep) return;
            const showEmailStep = step === 'email';
            emailStep.classList.toggle('hidden', !showEmailStep);
            passwordStep.classList.toggle('hidden', showEmailStep);
        }

        function backToEmailStep() {
            selectedUser = null;
            selectedRole = null;
            selectedDesignation = '';
            const passwordInput = document.getElementById('password-input');
            if (passwordInput) passwordInput.value = '';
            clearPasswordError();
            clearEmailError();
            setLoginStep('email');
            const emailInput = document.getElementById('login-email-input');
            if (emailInput) emailInput.focus();
        }

        function handleEmailProceed() {
            const emailInput = document.getElementById('login-email-input');
            if (!emailInput) return;
            const email = normalizeEmail(emailInput.value);
            clearEmailError();

            if (!email) {
                showEmailError('Please enter your email');
                return;
            }

            const verifyBtn = document.querySelector('#login-step-email .password-signin-btn');
            if (verifyBtn) {
                verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
                verifyBtn.disabled = true;
            }

            fetch(`${API_BASE_URL}/api/auth/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            }).then(res => {
                if (!res.ok) throw new Error('Not found');
                return res.json();
            }).then(data => {
                const user = data.user;
                selectedUser = user.username;
                selectedRole = user.role;
                selectedDesignation = user.role === 'admin' ? 'Admin' : 'Team Member';

                const userAvatar = document.getElementById('password-user-avatar');
                const userNameLabel = document.getElementById('password-user-name');
                const userDesignationLabel = document.getElementById('password-user-designation');
                const welcomeName = document.getElementById('login-welcome-name');

                if (userAvatar) {
                    userAvatar.src = 'assets/logo.jpg';
                }
                if (userNameLabel) userNameLabel.textContent = selectedUser;
                if (userDesignationLabel) userDesignationLabel.textContent = selectedDesignation;
                if (welcomeName) welcomeName.textContent = selectedUser;

                const toggleBtn = document.getElementById('password-toggle-btn');
                const passwordInput = document.getElementById('password-input');
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                if (passwordInput) {
                    passwordInput.type = 'password';
                    passwordInput.value = '';
                }
                clearPasswordError();
                setLoginStep('password');
                if (passwordInput) passwordInput.focus();
            }).catch(err => {
                showEmailError('No account found for this email');
                showToast('Email not registered', true);
            }).finally(() => {
                if (verifyBtn) {
                    verifyBtn.innerHTML = '<i class="fas fa-arrow-right"></i>Proceed';
                    verifyBtn.disabled = false;
                }
            });
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('password-input');
            const toggleBtn = document.getElementById('password-toggle-btn');
            if (!input || !toggleBtn) return;
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            toggleBtn.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        }

        function verifyPassword() {
            const passwordInput = document.getElementById('password-input');
            const emailInput = document.getElementById('login-email-input');
            if (!passwordInput || !selectedUser) {
                showToast('Start with your email first', true);
                backToEmailStep();
                return;
            }

            const pwd = passwordInput.value;
            const email = normalizeEmail(emailInput.value);

            const signinBtn = document.querySelector('#login-step-password .password-signin-btn');
            if (signinBtn) {
                signinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
                signinBtn.disabled = true;
            }

            fetch(`${API_BASE_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: email, password: pwd })
            }).then(res => res.json().then(data => ({ status: res.status, data })))
                .then(result => {
                    if (result.status === 200) {
                        clearPasswordError();
                        localStorage.setItem('vcue_token', result.data.token);
                        setTimeout(() => login(selectedUser, selectedRole), 200);
                    } else {
                        showPasswordError(result.data.error || 'Incorrect Password');
                        showToast('Incorrect password', true);
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                }).catch(err => {
                    showPasswordError('Server error');
                }).finally(() => {
                    if (signinBtn) {
                        signinBtn.innerHTML = '<i class="fas fa-arrow-right-to-bracket"></i>Sign In';
                        signinBtn.disabled = false;
                    }
                });
        }

        document.getElementById('login-email-input').addEventListener('input', clearEmailError);
        document.getElementById('password-input').addEventListener('input', clearPasswordError);
        setLoginStep('email');
        document.getElementById('login-email-input').focus();


        function login(u, r) {
            // Show loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.add('active');

            // Hide login screen immediately
            document.getElementById('login-screen').style.display = 'none';

            // Update user info
            currentUser = u;
            currentRole = r;
            document.getElementById('current-user-display').textContent = u;
            document.getElementById('current-role-display').textContent = r;
            document.getElementById('welcome-user').textContent = u;
            document.getElementById('sidebar-role-label').innerText = r === 'Admin' ? 'Admin Dashboard' : `${u}'s Dashboard`;
            applyUserAccessToNavigation();

            // Hide department selection screen for ALL users
            document.getElementById('dept-select-screen').style.display = 'none';

            // Hide all panes initially
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('department-dashboard').classList.add('hidden-pane');

            // Load CRM data from backend
            loadAllData().then(() => {
                // After data is loaded, hide loading overlay and show appropriate dashboard
                setTimeout(() => {
                    loadingOverlay.classList.remove('active');

                    routeToDefaultSection();
                    showToast(`Welcome, ${u}!`);
                }, 800); // Small delay to ensure smooth transition
            }).catch(error => {
                // Handle error case
                console.error('Error loading CRM data:', error);
                loadingOverlay.classList.remove('active');

                // Still show dashboard with sample data
                routeToDefaultSection();

                showToast('Welcome! Using sample data', false);
            });
        }

        function logout() { location.reload(); }

        // Mobile sidebar toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        document.getElementById('mainContent').addEventListener('click', function () {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });
        window.addEventListener('resize', () => {
            if (!isLeadsMenuOpen) return;
            const submenu = document.getElementById('leads-submenu');
            if (submenu) submenu.style.maxHeight = `${submenu.scrollHeight}px`;
        });

        let isLeadsMenuOpen = false;
        function toggleLeadsMenu(forceState) {
            const submenu = document.getElementById('leads-submenu');
            const toggle = document.getElementById('nav-leads-toggle');
            if (!submenu || !toggle) return;
            isLeadsMenuOpen = typeof forceState === 'boolean' ? forceState : !isLeadsMenuOpen;
            submenu.classList.toggle('open', isLeadsMenuOpen);
            toggle.classList.toggle('expanded', isLeadsMenuOpen);
            submenu.style.maxHeight = isLeadsMenuOpen ? `${submenu.scrollHeight}px` : '0px';
        }

        function setActiveNav(section) {
            const navMap = {
                home: 'nav-home',
                digital: 'nav-leads-digital',
                abroad: 'nav-leads-abroad',
                domestic: 'nav-leads-domestic',
                store: 'nav-leads-store',
                gmeet: 'nav-gmeet',
                pipeline: 'nav-pipeline',
                vcueconnect: 'nav-vcue-connect',
                meta: 'nav-meta',
                users: 'nav-user-management'
            };
            document.querySelectorAll('.nav-item, .nav-sub-item').forEach(item => item.classList.remove('active'));
            const target = document.getElementById(navMap[section]);
            if (target) target.classList.add('active');
            const isLeadSection = ['digital', 'abroad', 'domestic', 'store'].includes(section);
            document.getElementById('nav-leads-toggle').classList.toggle('active', isLeadSection);
            toggleLeadsMenu(isLeadSection);
        }

        function getUserAccessMap(userName = currentUser) {
            const user = USERS[userName];
            if (!user) return createDefaultFeatureAccess('Team Member');
            return normalizeFeatureAccess(user.featureAccess, user.role);
        }

        function hasFeatureAccess(featureKey, userName = currentUser) {
            const access = getUserAccessMap(userName);
            return Boolean(access[featureKey]);
        }

        function applyUserAccessToNavigation() {
            if (!currentUser || !USERS[currentUser]) return;
            const access = getUserAccessMap(currentUser);

            const setDisplay = (id, visible, mode = 'flex') => {
                const node = document.getElementById(id);
                if (!node) return;
                node.style.display = visible ? mode : 'none';
            };

            const canSeeHome = currentRole === 'Admin' && access.home;
            setDisplay('nav-home', canSeeHome);
            setDisplay('nav-leads-digital', access.digital);
            setDisplay('nav-leads-abroad', access.abroad);
            setDisplay('nav-leads-domestic', access.domestic);
            setDisplay('nav-leads-store', access.store);
            setDisplay('nav-gmeet', access.gmeet);
            setDisplay('nav-pipeline', access.pipeline);
            setDisplay('nav-vcue-connect', access.vcueconnect);
            setDisplay('nav-meta', access.meta);
            setDisplay('nav-user-management', currentRole === 'Admin');

            const hasAnyLeadMenuAccess = access.digital || access.abroad || access.domestic || access.store;
            setDisplay('nav-leads-toggle', hasAnyLeadMenuAccess);
            if (!hasAnyLeadMenuAccess) {
                toggleLeadsMenu(false);
            } else if (isLeadsMenuOpen) {
                const submenu = document.getElementById('leads-submenu');
                if (submenu) submenu.style.maxHeight = `${submenu.scrollHeight}px`;
            }
        }

        function getDefaultSectionForCurrentUser() {
            const preferredOrder = currentRole === 'Admin'
                ? ['home', 'digital', 'abroad', 'domestic', 'store', 'gmeet', 'pipeline', 'vcueconnect', 'meta']
                : ['digital', 'store', 'gmeet', 'pipeline', 'vcueconnect', 'abroad', 'domestic', 'meta'];
            return preferredOrder.find((section) => hasFeatureAccess(section)) || null;
        }

        function routeToDefaultSection() {
            const defaultSection = getDefaultSectionForCurrentUser();
            if (!defaultSection) {
                showToast('No dashboard access is configured for this account', true);
                return;
            }
            if (defaultSection === 'home') {
                showHomeAnalytics();
            } else if (['digital', 'abroad', 'domestic'].includes(defaultSection)) {
                selectDepartment(defaultSection);
            } else if (defaultSection === 'store') {
                showStore();
            } else if (defaultSection === 'gmeet') {
                showGMeet();
            } else if (defaultSection === 'pipeline') {
                showPipeline();
            } else if (defaultSection === 'vcueconnect') {
                showVCueConnect();
            } else if (defaultSection === 'meta') {
                showMetaIntegration();
            }
        }

        function deepClone(value) {
            return JSON.parse(JSON.stringify(value));
        }

        function generateLeadId(prefix = 'LD') {
            return `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
        }

        function formatDateOnly(value) {
            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) return new Date().toISOString().slice(0, 10);
            return parsed.toISOString().slice(0, 10);
        }

        function pickField(record, keys, fallback = '') {
            if (!record || typeof record !== 'object') return fallback;
            for (const key of keys) {
                const value = record[key];
                if (value !== undefined && value !== null && String(value).trim() !== '') return value;
            }
            const lowercaseMap = {};
            Object.keys(record).forEach((key) => {
                lowercaseMap[key.toLowerCase()] = record[key];
            });
            for (const key of keys) {
                const value = lowercaseMap[String(key).toLowerCase()];
                if (value !== undefined && value !== null && String(value).trim() !== '') return value;
            }
            return fallback;
        }

        function normalizeDepartment(value, fallback = 'digital') {
            const dept = String(value || fallback).toLowerCase().trim();
            if (dept.includes('abroad')) return 'abroad';
            if (dept.includes('domestic') || dept.includes('career')) return 'domestic';
            if (dept.includes('store')) return 'store';
            return 'digital';
        }

        function normalizeLeadRecord(record = {}, departmentFallback = 'digital') {
            const department = normalizeDepartment(
                pickField(record, ['department', 'Department'], departmentFallback),
                departmentFallback
            );
            return {
                id: String(pickField(record, ['id', 'leadId', 'lead_id'], generateLeadId('LD'))),
                name: String(pickField(record, ['name', 'Name'], 'Unnamed')),
                email: String(pickField(record, ['email', 'Email'], '-')),
                phone: String(pickField(record, ['phone', 'Phone'], '-')),
                source: String(pickField(record, ['source', 'Source'], 'Direct')),
                budget: String(pickField(record, ['budget', 'Budget'], '-')),
                owner: String(pickField(record, ['owner', 'leadOwner', 'lead_owner', 'Lead Owner'], 'Unassigned')),
                stage: String(pickField(record, ['stage', 'Stage'], 'New')),
                remark: String(pickField(record, ['remark', 'Remark'], 'No remarks')),
                department,
                dateAdded: formatDateOnly(pickField(record, ['dateAdded', 'date_added', 'Date Added'], new Date().toISOString()))
            };
        }

        function normalizeStoreLeadRecord(record = {}) {
            return {
                id: String(pickField(record, ['id', 'leadId', 'lead_id'], generateLeadId('ST'))),
                name: String(pickField(record, ['name', 'Name'], 'Unnamed')),
                email: String(pickField(record, ['email', 'Email'], '-')),
                phone: String(pickField(record, ['phone', 'Phone'], '-')),
                source: String(pickField(record, ['source', 'Source'], 'Direct')),
                budget: String(pickField(record, ['budget', 'Budget'], '-')),
                owner: String(pickField(record, ['owner', 'leadOwner', 'lead_owner', 'Lead Owner'], 'Unassigned')),
                stage: String(pickField(record, ['stage', 'Stage'], 'New')),
                remark: String(pickField(record, ['remark', 'Remark'], 'No remarks')),
                dateAdded: formatDateOnly(pickField(record, ['dateAdded', 'date_added', 'Date Added'], new Date().toISOString()))
            };
        }

        function normalizeGMeetRecord(record = {}) {
            return {
                id: String(pickField(record, ['id', 'meetingId', 'meeting_id'], generateLeadId('GM'))),
                leadOwner: String(pickField(record, ['leadOwner', 'Lead Owner'], 'Unassigned')),
                leadName: String(pickField(record, ['leadName', 'Lead Name'], 'Unnamed')),
                meetDate: String(pickField(record, ['meetDate', 'G Meet Date'], '-')),
                agenda: String(pickField(record, ['agenda', 'Agenda'], '-')),
                outcome: String(pickField(record, ['outcome', 'Outcome'], '-')),
                proposalShared: String(pickField(record, ['proposalShared', 'Proposal Shared'], 'No')),
                amountPitched: String(pickField(record, ['amountPitched', 'Amount Pitched'], '₹0')),
                department: String(pickField(record, ['department', 'Department'], 'General'))
            };
        }

        function extractArrayPayload(payload) {
            if (Array.isArray(payload)) return payload;
            if (payload && Array.isArray(payload.data)) return payload.data;
            if (payload && payload.data && Array.isArray(payload.data.rows)) return payload.data.rows;
            if (payload && Array.isArray(payload.rows)) return payload.rows;
            if (payload && Array.isArray(payload.items)) return payload.items;
            return [];
        }

        function extractSinglePayload(payload) {
            if (!payload) return null;
            if (Array.isArray(payload)) return payload[0] || null;
            if (payload.data && !Array.isArray(payload.data)) return payload.data;
            if (payload.row && typeof payload.row === 'object') return payload.row;
            if (payload.item && typeof payload.item === 'object') return payload.item;
            return payload;
        }

        async function requestBackend(endpoint, options = {}) {
            const config = {
                method: options.method || 'GET',
                headers: { Accept: 'application/json' }
            };
            const token = localStorage.getItem('vcue_token');
            if (token) {
                config.headers['Authorization'] = `Bearer ${token}`;
            }
            if (options.body instanceof FormData) {
                config.body = options.body;
            } else if (options.body !== undefined) {
                config.headers['Content-Type'] = 'application/json';
                config.body = JSON.stringify(options.body);
            }
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            if (!response.ok) {
                throw new Error(`Backend request failed (${response.status})`);
            }
            if (response.status === 204) return null;
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) return null;
            return response.json();
        }

        async function fetchCollectionFromBackend(endpoint, fallbackRows, normalizeRow, label) {
            try {
                const payload = await requestBackend(endpoint);
                const rows = extractArrayPayload(payload);
                return { rows: rows.map(normalizeRow), fallbackUsed: false };
            } catch (error) {
                console.error(`Error loading ${label}:`, error);
                return { rows: deepClone(fallbackRows), fallbackUsed: true };
            }
        }

        async function loadAllData(options = {}) {
            const silent = Boolean(options.silent);
            const fallbackLeads = sampleLeads.map((lead) => normalizeLeadRecord(lead, lead.department || 'digital'));
            const fallbackStoreLeads = sampleStoreLeads.map((lead) => normalizeStoreLeadRecord(lead));
            const fallbackGMeets = sampleGMeets.map((meeting) => normalizeGMeetRecord(meeting));

            const [leadResponse, storeResponse, gmeetResponse] = await Promise.all([
                fetchCollectionFromBackend(API_ENDPOINTS.leads, fallbackLeads, (row) => normalizeLeadRecord(row, row.department || 'digital'), 'leads'),
                fetchCollectionFromBackend(API_ENDPOINTS.storeLeads, fallbackStoreLeads, normalizeStoreLeadRecord, 'store leads'),
                fetchCollectionFromBackend(API_ENDPOINTS.gmeetMeetings, fallbackGMeets, normalizeGMeetRecord, 'G Meet entries')
            ]);

            leads = leadResponse.rows;
            storeLeads = storeResponse.rows;
            gmeetMeetings = gmeetResponse.rows;

            if (currentRole === 'Team Member') {
                const myName = (currentUser || '').toLowerCase();
                leads = leads.filter((lead) => (lead.owner || '').toLowerCase() === myName);
                gmeetMeetings = gmeetMeetings.filter((meeting) => (meeting.leadOwner || '').toLowerCase() === myName);
            }

            if (selectedLeadId && !leads.some((lead) => lead.id === selectedLeadId)) {
                selectedLeadId = null;
            }

            if (activeDepartment) {
                populateDropdowns();
                updateStatsAndTable();
            }
            populateGMeetOwnerFilter();
            populateGMeetDeptFilter();
            renderGMeetTable();
            updateStoreDashboard();
            if (currentRole === 'Admin') {
                renderHomeAnalytics();
            }

            if (!silent) {
                const usedFallback = leadResponse.fallbackUsed || storeResponse.fallbackUsed || gmeetResponse.fallbackUsed;
                showToast(usedFallback ? 'Backend unavailable. Showing sample CRM data' : 'CRM data synced from MySQL backend', usedFallback);
            }
        }

        // ========== DEPARTMENT DASHBOARD FUNCTIONS (unchanged) ==========
        function populateDropdowns() {
            if (!activeDepartment) return;
            let deptLeads = leads.filter(l => l.department === activeDepartment);

            const sources = [...new Set(deptLeads.map(l => l.source).filter(Boolean))].sort();
            const owners = [...new Set(deptLeads.map(l => l.owner).filter(Boolean))].sort();
            const stages = [...new Set(deptLeads.map(l => l.stage).filter(Boolean))].sort();

            renderDropdown('source', sources);
            renderDropdown('owner', owners);
            renderDropdown('stage', stages);
        }

        function renderDropdown(field, values) {
            const dropdown = document.getElementById(`${field}-dropdown`);
            let html = `<div class="filter-dropdown-item p-2 hover:bg-gray-700 cursor-pointer" onclick="setColumnFilter('${field}', null)">All ${field}s</div>`;
            values.forEach(val => {
                const activeClass = columnFilters[field] === val ? 'bg-blue-600' : '';
                html += `<div class="filter-dropdown-item p-2 hover:bg-gray-700 cursor-pointer ${activeClass}" onclick="setColumnFilter('${field}', '${val.replace(/'/g, "\\'")}')">${val}</div>`;
            });
            dropdown.innerHTML = html;
        }

        function toggleDropdown(field) {
            if (currentRole === 'Team Member' && field === 'owner') {
                showToast('You can only view your own leads', true);
                return;
            }
            if (openDropdown) {
                document.getElementById(`${openDropdown}-dropdown`).classList.remove('show');
            }
            const current = document.getElementById(`${field}-dropdown`);
            if (openDropdown === field) {
                current.classList.remove('show');
                openDropdown = null;
            } else {
                current.classList.add('show');
                openDropdown = field;
            }
        }

        document.addEventListener('click', function (e) {
            if (!e.target.closest('.filterable-th')) {
                if (openDropdown) {
                    document.getElementById(`${openDropdown}-dropdown`).classList.remove('show');
                    openDropdown = null;
                }
            }
        });

        function setColumnFilter(field, value) {
            columnFilters[field] = value;
            document.getElementById(`${field}-dropdown`).classList.remove('show');
            openDropdown = null;
            applyFilters();
        }

        function selectDepartment(dept) {
            if (!hasFeatureAccess(dept)) {
                showToast('This department access is not enabled for your account', true);
                return;
            }
            activeDepartment = dept;
            selectedLeadId = null;
            activePopupLead = null;
            searchTerm = ''; filterDate = null;
            if (currentRole !== 'Team Member') {
                columnFilters = { owner: null, source: null, stage: null };
            } else {
                columnFilters = { owner: currentUser, source: null, stage: null };
            }
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFilter').value = '';

            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.remove('hidden-pane');
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');

            const titles = { digital: 'Digital Sales', abroad: 'Study Abroad', domestic: 'Career Counselling' };
            let title = titles[dept];
            if (currentRole === 'Team Member') title = `👤 ${currentUser}'s Leads (${title})`;
            document.getElementById('dept-dashboard-title').innerHTML = title + ' <span class="dept-indicator">' + dept.toUpperCase() + '</span>';

            setTimeout(() => {
                populateDropdowns();
                updateStatsAndTable();
            }, 50);
            setActiveNav(dept);
        }

        function filterLeads() {
            if (!activeDepartment) return [];
            let filtered = leads.filter(l => l.department === activeDepartment);

            if (searchTerm.trim() !== '') {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(l =>
                    l.name.toLowerCase().includes(term) ||
                    l.phone.includes(term) ||
                    l.email.toLowerCase().includes(term)
                );
            }

            if (filterDate) {
                const filterTime = filterDate.getTime();
                filtered = filtered.filter(l => {
                    if (!l.dateAdded) return true;
                    const leadTime = new Date(l.dateAdded).getTime();
                    return leadTime >= filterTime;
                });
            }

            if (columnFilters.owner) filtered = filtered.filter(l => l.owner === columnFilters.owner);
            if (columnFilters.source) filtered = filtered.filter(l => l.source === columnFilters.source);
            if (columnFilters.stage) filtered = filtered.filter(l => l.stage === columnFilters.stage);

            return filtered;
        }

        function getLeadById(leadId) {
            return leads.find((lead) => String(lead.id) === String(leadId));
        }

        function selectLead(leadId) {
            selectedLeadId = leadId ? String(leadId) : null;
            document.querySelectorAll('#dept-table-body tr[data-lead-id]').forEach((row) => {
                row.classList.toggle('lead-row-selected', row.dataset.leadId === selectedLeadId);
            });
        }

        function updateStatsAndTable() {
            const filtered = filterLeads();
            if (selectedLeadId && !filtered.some((lead) => String(lead.id) === String(selectedLeadId))) {
                selectedLeadId = null;
            }
            const total = filtered.length;
            const hot = filtered.filter(l => l.stage.toLowerCase() === 'hot').length;
            const warm = filtered.filter(l => l.stage.toLowerCase() === 'warm').length;
            const cold = filtered.filter(l => l.stage.toLowerCase() === 'cold').length;

            document.getElementById('dept-stats').innerHTML = `
        <div class="stats-card"><p class="text-gray-400 text-sm">Total Leads</p><p class="text-3xl font-bold text-white mt-2">${total}</p></div>
        <div class="stats-card border-l-4 border-l-red-500"><p class="text-gray-400 text-sm">Hot</p><p class="text-3xl font-bold text-red-400 mt-2">${hot}</p></div>
        <div class="stats-card border-l-4 border-l-yellow-500"><p class="text-gray-400 text-sm">Warm</p><p class="text-3xl font-bold text-yellow-400 mt-2">${warm}</p></div>
        <div class="stats-card border-l-4 border-l-blue-500"><p class="text-gray-400 text-sm">Cold</p><p class="text-3xl font-bold text-blue-400 mt-2">${cold}</p></div>
    `;

            let chipHtml = '';
            if (columnFilters.owner && currentRole !== 'Team Member') chipHtml += `<span class="filter-chip"><i class="fas fa-user"></i> Owner: ${columnFilters.owner} <i class="fas fa-times-circle ml-1 cursor-pointer" onclick="clearFilter('owner')"></i></span>`;
            else if (columnFilters.owner && currentRole === 'Team Member') chipHtml += `<span class="filter-chip bg-blue-800"><i class="fas fa-user"></i> My Leads (${columnFilters.owner}) </span>`;
            if (columnFilters.source) chipHtml += `<span class="filter-chip"><i class="fas fa-tag"></i> Source: ${columnFilters.source} <i class="fas fa-times-circle ml-1 cursor-pointer" onclick="clearFilter('source')"></i></span>`;
            if (columnFilters.stage) chipHtml += `<span class="filter-chip"><i class="fas fa-chart-simple"></i> Stage: ${columnFilters.stage} <i class="fas fa-times-circle ml-1 cursor-pointer" onclick="clearFilter('stage')"></i></span>`;
            document.getElementById('active-filter-chip').innerHTML = chipHtml;

            const tbody = document.getElementById('dept-table-body');
            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No leads match filters</td></tr>';
            } else {
                filtered.forEach(lead => {
                    let stageClass = '';
                    if (lead.stage.toLowerCase() === 'hot') stageClass = 'status-hot';
                    else if (lead.stage.toLowerCase() === 'warm') stageClass = 'status-warm';
                    else if (lead.stage.toLowerCase() === 'cold') stageClass = 'status-cold';
                    else stageClass = 'bg-gray-700 text-gray-300';

                    const preview = lead.remark.split('\n').map(s => s.trim()).filter(s => s).join(' • ') || lead.remark.substring(0, 60);

                    // Clean phone number for WhatsApp (remove non-digits)
                    const cleanPhone = lead.phone.replace(/\D/g, '');
                    // Ensure it starts with 91 for India (assuming Indian numbers)
                    const whatsappNumber = cleanPhone.startsWith('91') ? cleanPhone : '91' + cleanPhone;

                    const row = document.createElement('tr');
                    row.dataset.leadId = String(lead.id);
                    if (String(lead.id) === String(selectedLeadId)) {
                        row.classList.add('lead-row-selected');
                    }
                    row.innerHTML = `
                <td class="font-medium">
                    <div class="lead-name-cell">
                        <span class="lead-name-text">${lead.name}</span>
                        <button class="read-more-btn row-edit-btn js-edit-lead-btn">Edit</button>
                    </div>
                </td>
                <td>
                    <div class="contact-action">
                        <a href="mailto:${lead.email}" class="contact-icon email-icon" title="Send Email">
                            <i class="fas fa-envelope"></i>
                        </a>
                        <span>${lead.email}</span>
                    </div>
                </td>
                <td>
                    <div class="contact-action">
                        <a href="https://wa.me/${whatsappNumber}" target="_blank" class="contact-icon whatsapp-icon" title="Send WhatsApp Message">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <span>${lead.phone}</span>
                    </div>
                </td>
                <td><span class="source-badge">${lead.source}</span></td>
                <td>${lead.budget}</td>
                <td>${lead.owner}</td>
                <td><span class="status-badge ${stageClass}">${lead.stage}</span></td>
                <td>
                    <div class="remark-cell">
                        <span class="remark-preview">${preview}</span>
                        <button class="read-more-btn js-read-lead-btn">View Details</button>
                    </div>
                </td>
            `;
                    row.addEventListener('click', (event) => {
                        if (event.target.closest('a,button')) return;
                        selectLead(lead.id);
                    });
                    const readBtn = row.querySelector('.js-read-lead-btn');
                    if (readBtn) {
                        readBtn.addEventListener('click', (event) => {
                            event.stopPropagation();
                            selectLead(lead.id);
                            showLeadPopup(lead);
                        });
                    }
                    const editBtn = row.querySelector('.js-edit-lead-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', (event) => {
                            event.stopPropagation();
                            selectLead(lead.id);
                            openEditLeadDetails(lead.id);
                        });
                    }
                    tbody.appendChild(row);
                });
            }
        }

        function clearFilter(field) {
            if (currentRole === 'Team Member' && field === 'owner') {
                showToast('Cannot remove owner filter', true);
                return;
            }
            columnFilters[field] = null;
            applyFilters();
            populateDropdowns();
        }

        function parseRemarkTimeline(remarkStr) {
            const lines = parseRemarkLines(remarkStr);
            return lines.map((line, index) => {
                const parts = splitRemarkLine(line);
                return {
                    index,
                    date: parts.date,
                    message: parts.message,
                    text: line
                };
            });
        }

        function parseRemarkLines(remarkStr) {
            if (!remarkStr) return [];
            const normalized = String(remarkStr).trim();
            if (!normalized || normalized.toLowerCase() === 'no remarks') return [];
            return normalized.split('\n').map((line) => line.trim()).filter((line) => line !== '');
        }

        function splitRemarkLine(line) {
            const raw = String(line || '').trim();
            if (!raw) return { date: 'Entry', message: '' };

            const separatorIndex = raw.indexOf(' - ');
            if (separatorIndex > 0) {
                const date = raw.slice(0, separatorIndex).trim();
                const message = raw.slice(separatorIndex + 3).trim();
                return { date: date || 'Entry', message: message || raw };
            }

            const tokens = raw.split(/\s+/);
            if (/^\d{4}-\d{2}-\d{2}$/.test(tokens[0])) {
                return {
                    date: tokens[0],
                    message: raw.slice(tokens[0].length).trim().replace(/^[-:]\s*/, '') || raw
                };
            }
            if (/^\d{1,2}$/.test(tokens[0]) && /^[A-Za-z]{3,}$/.test(tokens[1] || '')) {
                return {
                    date: `${tokens[0]} ${tokens[1]}`,
                    message: tokens.slice(2).join(' ').trim() || raw
                };
            }
            return { date: 'Entry', message: raw };
        }
        function showLeadPopup(lead) {
            activePopupLead = lead;
            if (lead?.id) {
                selectLead(lead.id);
            }
            document.querySelector('#lead-popup .lead-id').textContent = `ID: #${lead.id || 'N/A'}`;
            const grid = document.getElementById('popup-lead-details');

            // Determine stage class
            const stageClass = lead.stage?.toLowerCase() === 'hot' ? 'hot' :
                lead.stage?.toLowerCase() === 'warm' ? 'warm' : 'cold';

            grid.innerHTML = `
        <div class="info-item">
            <span class="info-label"><i class="fas fa-user"></i> Name</span>
            <span class="info-value">${lead.name}</span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-envelope"></i> Email</span>
            <span class="info-value email-value">${lead.email}</span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-phone-alt"></i> Phone</span>
            <span class="info-value phone-value">${lead.phone}</span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-tag"></i> Source</span>
            <span class="info-value">${lead.source}</span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-coins"></i> Budget</span>
            <span class="info-value">${lead.budget}</span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-user-tie"></i> Owner</span>
            <span class="info-value">${lead.owner}</span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-chart-line"></i> Stage</span>
            <span class="info-value">
                <span class="stage-badge ${stageClass}">${lead.stage}</span>
            </span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-layer-group"></i> Dept</span>
            <span class="info-value">${lead.department || 'Store'}</span>
        </div>
        <div class="info-item">
            <span class="info-label"><i class="fas fa-calendar-plus"></i> Date added</span>
            <span class="info-value">${lead.dateAdded || '—'}</span>
        </div>
    `;

            const timelineEntries = parseRemarkTimeline(lead.remark);
            activeTimelineEntries = timelineEntries;
            activeRemarkIndex = null;
            const container = document.getElementById('popup-remark-container');
            const remarkInput = document.getElementById('popup-remark-input');
            const remarkHint = document.getElementById('remark-editor-hint');
            document.getElementById('timeline-count').textContent = `${timelineEntries.length} entries`;
            if (remarkInput) remarkInput.value = '';
            if (remarkHint) remarkHint.textContent = 'Click any timeline item to edit that specific remark.';

            if (timelineEntries.length === 0) {
                container.innerHTML = '<div class="empty-timeline"><i class="far fa-clock"></i> No remarks available</div>';
                if (remarkHint) remarkHint.textContent = 'No remarks yet. Add your first remark below.';
            } else {
                let timelineHtml = '';
                timelineEntries.forEach((entry, idx) => {
                    timelineHtml += `
                <div class="timeline-item" data-remark-index="${idx}" style="--item-index: ${idx}">
                    <div class="timeline-badge">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-date">
                            <i class="far fa-clock"></i>
                            <span class="date-badge">${entry.date}</span>
                        </div>
                        <div class="timeline-text">${entry.message}</div>
                    </div>
                </div>
            `;
                });
                container.innerHTML = timelineHtml;
                container.querySelectorAll('.timeline-item').forEach((item) => {
                    item.addEventListener('click', () => {
                        const index = Number(item.dataset.remarkIndex);
                        selectRemarkEntry(index);
                    });
                });
            }

            document.getElementById('lead-popup').classList.add('active');
        }

        function selectRemarkEntry(index) {
            if (!Number.isInteger(index) || index < 0 || index >= activeTimelineEntries.length) return;
            activeRemarkIndex = index;
            document.querySelectorAll('#popup-remark-container .timeline-item').forEach((item) => {
                item.classList.toggle('active', Number(item.dataset.remarkIndex) === index);
            });

            const selectedEntry = activeTimelineEntries[index];
            const remarkInput = document.getElementById('popup-remark-input');
            const remarkHint = document.getElementById('remark-editor-hint');
            if (remarkInput) remarkInput.value = selectedEntry.message || selectedEntry.text || '';
            if (remarkHint) remarkHint.textContent = `Editing remark ${index + 1}. Update and click "Update Remark".`;
        }

        function getPopupLeadForRemarkUpdate() {
            if (!activePopupLead?.id) return null;
            return getLeadById(activePopupLead.id) || activePopupLead;
        }

        async function persistRemarkChanges(updatedLead, successMessage) {
            upsertLeadCollection([updatedLead]);
            activePopupLead = updatedLead;
            selectedLeadId = updatedLead.id;
            populateDropdowns();
            updateStatsAndTable();
            if (currentRole === 'Admin') renderHomeAnalytics();

            const syncResult = await syncLeadWithBackend(updatedLead, 'edit');
            if (syncResult.lead) {
                upsertLeadCollection([syncResult.lead]);
                activePopupLead = syncResult.lead;
                selectedLeadId = syncResult.lead.id;
            }
            showLeadPopup(activePopupLead);
            showToast(syncResult.synced ? successMessage : `${successMessage} locally. Backend sync pending`, !syncResult.synced);
        }

        async function addRemarkEntry() {
            const lead = getPopupLeadForRemarkUpdate();
            if (!lead) {
                showToast('Open a lead first to add remarks', true);
                return;
            }
            const remarkInput = document.getElementById('popup-remark-input');
            const remarkMessage = remarkInput ? remarkInput.value.trim() : '';
            if (!remarkMessage) {
                showToast('Enter a remark first', true);
                return;
            }
            const remarkLines = parseRemarkLines(lead.remark);
            remarkLines.push(`${formatDateOnly(new Date())} - ${remarkMessage}`);
            const updatedLead = { ...lead, remark: remarkLines.join('\n') };
            await persistRemarkChanges(updatedLead, 'Remark added');
        }

        async function updateSelectedRemark() {
            const lead = getPopupLeadForRemarkUpdate();
            if (!lead) {
                showToast('Open a lead first to update remarks', true);
                return;
            }
            const remarkInput = document.getElementById('popup-remark-input');
            const remarkMessage = remarkInput ? remarkInput.value.trim() : '';
            if (!remarkMessage) {
                showToast('Enter the updated remark first', true);
                return;
            }

            const remarkLines = parseRemarkLines(lead.remark);
            if (remarkLines.length === 0) {
                showToast('No existing remarks. Use Add Remark first', true);
                return;
            }

            const indexToUpdate =
                activeRemarkIndex !== null && activeRemarkIndex >= 0 && activeRemarkIndex < remarkLines.length
                    ? activeRemarkIndex
                    : remarkLines.length - 1;

            const existingParts = splitRemarkLine(remarkLines[indexToUpdate]);
            const datePrefix = existingParts.date && existingParts.date !== 'Entry'
                ? existingParts.date
                : formatDateOnly(new Date());
            remarkLines[indexToUpdate] = `${datePrefix} - ${remarkMessage}`;

            const updatedLead = { ...lead, remark: remarkLines.join('\n') };
            await persistRemarkChanges(updatedLead, 'Remark updated');
        }

        function editLead() {
            openEditLeadDetails(activePopupLead?.id || selectedLeadId);
        }

        function openEditLeadDetails(targetLeadId = null) {
            if (!activeDepartment) {
                showToast('Open a Leads Centre department first', true);
                return;
            }
            const leadIdToEdit = targetLeadId || selectedLeadId;
            if (!leadIdToEdit) {
                showToast('Select a lead to edit', true);
                return;
            }
            const lead = getLeadById(leadIdToEdit);
            if (!lead) {
                showToast('Selected lead is not available', true);
                return;
            }
            openLeadFormModal('edit', lead);
        }

        function openAddLeadModal() {
            if (!activeDepartment) {
                showToast('Open a Leads Centre department first', true);
                return;
            }
            openLeadFormModal('add');
        }

        function openLeadFormModal(mode, lead = null) {
            leadFormMode = mode;
            const form = document.getElementById('lead-form');
            const title = document.getElementById('lead-form-title');
            const submitBtn = document.getElementById('lead-form-submit-btn');
            const ownerInput = document.getElementById('lead-form-owner');
            const today = new Date().toISOString().slice(0, 10);
            const base = lead ? { ...lead } : {
                id: '',
                name: '',
                email: '',
                phone: '',
                source: '',
                budget: '',
                owner: currentUser || '',
                stage: 'New',
                remark: '',
                dateAdded: today
            };

            form.dataset.leadId = base.id || '';
            document.getElementById('lead-form-name').value = base.name || '';
            document.getElementById('lead-form-email').value = base.email === '-' ? '' : (base.email || '');
            document.getElementById('lead-form-phone').value = base.phone === '-' ? '' : (base.phone || '');
            document.getElementById('lead-form-source').value = base.source === 'Direct' ? '' : (base.source || '');
            document.getElementById('lead-form-budget').value = base.budget === '-' ? '' : (base.budget || '');
            document.getElementById('lead-form-owner').value = base.owner === 'Unassigned' ? '' : (base.owner || '');
            const stageMap = { hot: 'Hot', warm: 'Warm', cold: 'Cold', new: 'New' };
            const normalizedStage = stageMap[String(base.stage || 'New').toLowerCase()] || 'New';
            document.getElementById('lead-form-stage').value = normalizedStage;
            document.getElementById('lead-form-date').value = formatDateOnly(base.dateAdded || today);
            document.getElementById('lead-form-remark').value = base.remark === 'No remarks' ? '' : (base.remark || '');

            ownerInput.disabled = currentRole === 'Team Member';
            ownerInput.classList.toggle('opacity-70', ownerInput.disabled);
            ownerInput.classList.toggle('cursor-not-allowed', ownerInput.disabled);
            if (ownerInput.disabled) {
                ownerInput.value = currentUser || base.owner || '';
            }

            if (mode === 'edit') {
                title.textContent = 'Edit Lead Details';
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Update Lead';
            } else {
                title.textContent = 'Add New Lead';
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Lead';
            }
            document.getElementById('lead-form-modal').classList.add('active');
        }

        function closeLeadFormModal() {
            document.getElementById('lead-form-modal').classList.remove('active');
        }

        function collectLeadFormData() {
            const form = document.getElementById('lead-form');
            const leadId = form.dataset.leadId || generateLeadId('LD');
            const ownerValue = currentRole === 'Team Member'
                ? (currentUser || 'Unassigned')
                : (document.getElementById('lead-form-owner').value.trim() || 'Unassigned');
            return normalizeLeadRecord({
                id: leadId,
                name: document.getElementById('lead-form-name').value.trim(),
                email: document.getElementById('lead-form-email').value.trim() || '-',
                phone: document.getElementById('lead-form-phone').value.trim(),
                source: document.getElementById('lead-form-source').value.trim() || 'Direct',
                budget: document.getElementById('lead-form-budget').value.trim() || '-',
                owner: ownerValue,
                stage: document.getElementById('lead-form-stage').value || 'New',
                remark: document.getElementById('lead-form-remark').value.trim() || 'No remarks',
                department: activeDepartment || 'digital',
                dateAdded: document.getElementById('lead-form-date').value || new Date().toISOString()
            }, activeDepartment || 'digital');
        }

        function upsertLeadCollection(newLeads) {
            const byId = new Map(leads.map((lead) => [String(lead.id), lead]));
            newLeads.forEach((lead) => {
                const normalized = normalizeLeadRecord(lead, lead.department || activeDepartment || 'digital');
                byId.set(String(normalized.id), normalized);
            });
            leads = Array.from(byId.values());
        }

        async function syncLeadWithBackend(lead, mode) {
            const endpoint = mode === 'edit' ? API_ENDPOINTS.leadById(lead.id) : API_ENDPOINTS.leads;
            const method = mode === 'edit' ? 'PUT' : 'POST';
            try {
                const payload = await requestBackend(endpoint, { method, body: lead });
                const backendLead = extractSinglePayload(payload);
                if (!backendLead) return { synced: true, lead };
                return { synced: true, lead: normalizeLeadRecord(backendLead, lead.department) };
            } catch (error) {
                console.error(`Failed to ${mode === 'edit' ? 'update' : 'create'} lead:`, error);
                return { synced: false, lead };
            }
        }

        async function saveLeadDetails(event) {
            event.preventDefault();
            if (!activeDepartment) {
                showToast('Open a Leads Centre department first', true);
                return;
            }
            const draftLead = collectLeadFormData();
            if (!draftLead.name || !draftLead.phone) {
                showToast('Name and phone are required', true);
                return;
            }

            const mode = leadFormMode === 'edit' ? 'edit' : 'add';
            upsertLeadCollection([draftLead]);

            const syncResult = await syncLeadWithBackend(draftLead, mode);
            const finalLead = syncResult.lead || draftLead;
            upsertLeadCollection([finalLead]);
            selectedLeadId = finalLead.id;
            activePopupLead = finalLead;

            closeLeadFormModal();
            document.getElementById('lead-popup').classList.remove('active');
            populateDropdowns();
            updateStatsAndTable();
            if (currentRole === 'Admin') renderHomeAnalytics();

            if (syncResult.synced) {
                showToast(mode === 'edit' ? 'Lead details updated' : 'Lead added');
            } else {
                showToast(mode === 'edit' ? 'Lead updated locally. Backend sync pending' : 'Lead added locally. Backend sync pending', true);
            }
        }

        function triggerLeadCsvImport() {
            if (!activeDepartment) {
                showToast('Open a Leads Centre department first', true);
                return;
            }
            const fileInput = document.getElementById('lead-csv-input');
            fileInput.value = '';
            fileInput.click();
        }

        function parseLeadCsvFile(file, department) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (result) => {
                        const rows = Array.isArray(result.data) ? result.data : [];
                        const parsedLeads = rows
                            .map((row) => normalizeLeadRecord({ ...row, department }, department))
                            .filter((lead) => lead.name && lead.name.toLowerCase() !== 'unnamed');
                        resolve(parsedLeads);
                    },
                    error: reject
                });
            });
        }

        async function syncCsvImportWithBackend(file, department) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('department', department);
            try {
                const payload = await requestBackend(API_ENDPOINTS.importLeadsCsv, { method: 'POST', body: formData });
                const rows = extractArrayPayload(payload).map((row) => normalizeLeadRecord(row, department));
                return { synced: true, rows };
            } catch (error) {
                console.error('CSV sync failed:', error);
                return { synced: false, rows: [] };
            }
        }

        async function handleLeadCsvImport(event) {
            const input = event.target;
            const file = input.files && input.files[0];
            if (!file) return;

            try {
                const importedLeads = await parseLeadCsvFile(file, activeDepartment || 'digital');
                if (importedLeads.length === 0) {
                    showToast('No valid lead rows found in CSV', true);
                    return;
                }

                const scopedImportedLeads = currentRole === 'Team Member'
                    ? importedLeads.map((lead) => ({ ...lead, owner: currentUser || lead.owner }))
                    : importedLeads;

                upsertLeadCollection(scopedImportedLeads);
                populateDropdowns();
                updateStatsAndTable();

                const syncResult = await syncCsvImportWithBackend(file, activeDepartment || 'digital');
                if (syncResult.synced && syncResult.rows.length > 0) {
                    upsertLeadCollection(syncResult.rows);
                    populateDropdowns();
                    updateStatsAndTable();
                }
                if (currentRole === 'Admin') renderHomeAnalytics();

                const importedCount = syncResult.rows.length || scopedImportedLeads.length;
                if (syncResult.synced) {
                    showToast(`Imported ${importedCount} leads`);
                } else {
                    showToast(`Imported ${scopedImportedLeads.length} leads locally. Backend sync pending`, true);
                }
            } catch (error) {
                console.error('Lead CSV import failed:', error);
                showToast('Unable to import this CSV file', true);
            } finally {
                input.value = '';
            }
        }

        function applyFilters() {
            searchTerm = document.getElementById('searchInput').value;
            const dateStr = document.getElementById('dateFilter').value;
            filterDate = dateStr ? new Date(dateStr + 'T00:00:00') : null;
            if (currentRole === 'Team Member') {
                columnFilters.owner = currentUser;
            }
            updateStatsAndTable();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFilter').value = '';
            searchTerm = '';
            filterDate = null;
            if (currentRole === 'Team Member') {
                columnFilters = { owner: currentUser, source: null, stage: null };
            } else {
                columnFilters = { owner: null, source: null, stage: null };
            }
            updateStatsAndTable();
            populateDropdowns();
        }

        // ========== GMEET FUNCTIONS with Owner and Department Filter ==========
        function populateGMeetOwnerFilter() {
            const owners = [...new Set(gmeetMeetings.map(m => m.leadOwner).filter(Boolean))].sort();
            const select = document.getElementById('gmeetOwnerFilter');
            let options = '<option value="All">All Owners</option>';
            owners.forEach(owner => {
                options += `<option value="${owner}">${owner}</option>`;
            });
            select.innerHTML = options;
        }

        function populateGMeetDeptFilter() {
            const depts = [...new Set(gmeetMeetings.map(m => m.department).filter(Boolean))].sort();
            const select = document.getElementById('gmeetDeptFilter');
            let options = '<option value="All">All Departments</option>';
            depts.forEach(dept => {
                options += `<option value="${dept}">${dept}</option>`;
            });
            select.innerHTML = options;
        }

        function filterGMeets() {
            renderGMeetTable();
        }

        function renderGMeetTable() {
            let meetings = gmeetMeetings;
            const selectedOwner = document.getElementById('gmeetOwnerFilter').value;
            const selectedDept = document.getElementById('gmeetDeptFilter').value;

            if (selectedOwner !== 'All') {
                meetings = meetings.filter(m => m.leadOwner === selectedOwner);
            }
            if (selectedDept !== 'All') {
                meetings = meetings.filter(m => m.department === selectedDept);
            }
            if (currentRole === 'Team Member') {
                meetings = meetings.filter(m => m.leadOwner === currentUser);
            }
            const tbody = document.getElementById('gmeet-table-body');
            tbody.innerHTML = '';
            if (!meetings.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No meetings scheduled</td></tr>';
                return;
            }
            meetings.forEach(m => {
                const proposalClass = m.proposalShared === 'Yes' ? 'proposal-yes' : 'proposal-no';
                tbody.innerHTML += `<tr>
            <td>${m.leadOwner}</td>
            <td>${m.department || '—'}</td>
            <td>${m.leadName}</td>
            <td>${m.meetDate}</td>
            <td>${m.agenda}</td>
            <td>${m.outcome}</td>
            <td><span class="proposal-badge ${proposalClass}">${m.proposalShared}</span></td>
            <td>${m.amountPitched}</td>
        </tr>`;
            });
        }

        // ========== PIPELINE FUNCTIONS (unchanged) ==========
        function renderPipeline() {
            let meetings = gmeetMeetings;
            if (currentRole === 'Team Member') {
                meetings = meetings.filter(m => m.leadOwner === currentUser);
            }
            const pipelineByOwner = {};
            let totalPipeline = 0;
            meetings.forEach(meet => {
                const numeric = parseFloat(meet.amountPitched.replace(/[^0-9.]/g, '')) || 0;
                const owner = meet.leadOwner || 'Unassigned';
                pipelineByOwner[owner] = (pipelineByOwner[owner] || 0) + numeric;
                totalPipeline += numeric;
            });

            const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
            document.getElementById('total-pipeline-amount').innerText = formatter.format(totalPipeline).replace('₹', '₹');

            const grid = document.getElementById('pipeline-owner-grid');
            grid.innerHTML = '';
            const owners = Object.keys(pipelineByOwner).sort();
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            owners.forEach((owner, idx) => {
                const amount = pipelineByOwner[owner];
                grid.innerHTML += `
            <div class="pipeline-owner-card" style="border-left-color: ${colors[idx % colors.length]}">
                <div class="text-gray-300 text-sm mb-1">${owner}</div>
                <div class="text-2xl font-bold text-white">${formatter.format(amount).replace('₹', '₹')}</div>
                <div class="text-gray-500 text-xs mt-2">pipeline value</div>
            </div>
        `;
            });

            const detailBody = document.getElementById('pipeline-detail-table');
            detailBody.innerHTML = '';
            meetings.forEach(meet => {
                detailBody.innerHTML += `<tr><td>${meet.leadOwner}</td><td>${meet.leadName}</td><td>${meet.amountPitched}</td><td>${meet.meetDate}</td><td>${meet.outcome}</td></tr>`;
            });
        }

        // ========== STORE DASHBOARD FUNCTIONS ==========
        function showStore() {
            if (!hasFeatureAccess('store')) {
                showToast('Store dashboard access is disabled for your account', true);
                return;
            }
            activeDepartment = null;
            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.add('hidden-pane');
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.remove('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');
            setActiveNav('store');
            updateStoreDashboard();
        }

        function filterStoreLeads() {
            let filtered = storeLeads;

            if (storeSearchTerm.trim() !== '') {
                const term = storeSearchTerm.toLowerCase();
                filtered = filtered.filter(l =>
                    l.name.toLowerCase().includes(term) ||
                    l.phone.includes(term) ||
                    l.email.toLowerCase().includes(term)
                );
            }

            if (storeFilterDate) {
                const filterTime = storeFilterDate.getTime();
                filtered = filtered.filter(l => {
                    if (!l.dateAdded) return true;
                    const leadTime = new Date(l.dateAdded).getTime();
                    return leadTime >= filterTime;
                });
            }

            // Optionally apply team member owner filter if needed
            if (currentRole === 'Team Member') {
                filtered = filtered.filter(l => l.owner === currentUser);
            }

            return filtered;
        }

        function updateStoreDashboard() {
            const filtered = filterStoreLeads();
            const total = filtered.length;
            const hot = filtered.filter(l => l.stage.toLowerCase() === 'hot').length;
            const warm = filtered.filter(l => l.stage.toLowerCase() === 'warm').length;
            const cold = filtered.filter(l => l.stage.toLowerCase() === 'cold').length;

            document.getElementById('store-stats').innerHTML = `
        <div class="stats-card"><p class="text-gray-400 text-sm">Total Store Leads</p><p class="text-3xl font-bold text-white mt-2">${total}</p></div>
        <div class="stats-card border-l-4 border-l-red-500"><p class="text-gray-400 text-sm">Hot</p><p class="text-3xl font-bold text-red-400 mt-2">${hot}</p></div>
        <div class="stats-card border-l-4 border-l-yellow-500"><p class="text-gray-400 text-sm">Warm</p><p class="text-3xl font-bold text-yellow-400 mt-2">${warm}</p></div>
        <div class="stats-card border-l-4 border-l-blue-500"><p class="text-gray-400 text-sm">Cold</p><p class="text-3xl font-bold text-blue-400 mt-2">${cold}</p></div>
    `;

            const tbody = document.getElementById('store-table-body');
            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No store leads</td></tr>';
            } else {
                filtered.forEach(lead => {
                    let stageClass = '';
                    if (lead.stage.toLowerCase() === 'hot') stageClass = 'status-hot';
                    else if (lead.stage.toLowerCase() === 'warm') stageClass = 'status-warm';
                    else if (lead.stage.toLowerCase() === 'cold') stageClass = 'status-cold';
                    else stageClass = 'bg-gray-700 text-gray-300';

                    const preview = lead.remark.split('\n').map(s => s.trim()).filter(s => s).join(' • ') || lead.remark.substring(0, 60);

                    // Clean phone number for WhatsApp (remove non-digits)
                    const cleanPhone = lead.phone.replace(/\D/g, '');
                    // Ensure it starts with 91 for India (assuming Indian numbers)
                    const whatsappNumber = cleanPhone.startsWith('91') ? cleanPhone : '91' + cleanPhone;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td class="font-medium"><span class="lead-name-text">${lead.name}</span></td>
                <td>
                    <div class="contact-action">
                        <a href="mailto:${lead.email}" class="contact-icon email-icon" title="Send Email">
                            <i class="fas fa-envelope"></i>
                        </a>
                        <span>${lead.email}</span>
                    </div>
                </td>
                <td>
                    <div class="contact-action">
                        <a href="https://wa.me/${whatsappNumber}" target="_blank" class="contact-icon whatsapp-icon" title="Send WhatsApp Message">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <span>${lead.phone}</span>
                    </div>
                </td>
                <td><span class="source-badge">${lead.source}</span></td>
                <td>${lead.budget}</td>
                <td>${lead.owner}</td>
                <td><span class="status-badge ${stageClass}">${lead.stage}</span></td>
                <td>
                    <div class="remark-cell">
                        <span class="remark-preview">${preview}</span>
                        <button class="read-more-btn" onclick='showLeadPopup(${JSON.stringify(lead).replace(/'/g, "\\'")})'>View Details</button>
                    </div>
                </td>
            `;
                    tbody.appendChild(row);
                });
            }
        }

        function applyStoreFilters() {
            storeSearchTerm = document.getElementById('storeSearchInput').value;
            const dateStr = document.getElementById('storeDateFilter').value;
            storeFilterDate = dateStr ? new Date(dateStr + 'T00:00:00') : null;
            updateStoreDashboard();
        }

        function clearStoreFilters() {
            document.getElementById('storeSearchInput').value = '';
            document.getElementById('storeDateFilter').value = '';
            storeSearchTerm = '';
            storeFilterDate = null;
            updateStoreDashboard();
        }

        function exportStoreToExcel() {
            const filtered = filterStoreLeads();
            if (filtered.length === 0) { showToast('No store data', true); return; }
            const rows = [];
            rows.push('VCUE STORE LEADS');
            rows.push(['Name', 'Email', 'Phone', 'Source', 'Budget', 'Owner', 'Stage', 'Remark', 'DateAdded'].join(','));
            filtered.forEach(l => rows.push(`"${l.name}","${l.email}","${l.phone}","${l.source}","${l.budget}","${l.owner}","${l.stage}","${l.remark}","${l.dateAdded || ''}"`));
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `store_export_${Date.now()}.csv`; a.click();
            showToast('Exported');
        }

        // ========== HOME ANALYTICS (Admin only) ==========
        function showHomeAnalytics() {
            if (currentRole !== 'Admin' || !hasFeatureAccess('home')) {
                showToast('Home analytics access is disabled for your account', true);
                return;
            }
            activeDepartment = null;
            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.add('hidden-pane');
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.remove('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');
            setActiveNav('home');
            renderHomeAnalytics();
        }

        function showUserManagementSection() {
            if (currentRole !== 'Admin') {
                showToast('Only admins can manage users', true);
                return;
            }
            activeDepartment = null;
            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.add('hidden-pane');
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.remove('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');
            setActiveNav('users');
            renderUserManagementTable();
        }

        function updateHomeAnalyticsHeader() {
            const dateNode = document.getElementById('home-current-date');
            const greetingNode = document.getElementById('home-greeting-user');
            if (dateNode) {
                dateNode.textContent = new Date().toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
            if (greetingNode) {
                greetingNode.textContent = currentUser || 'User';
            }
        }

        function renderHomeAnalytics() {
            updateHomeAnalyticsHeader();
            // Build stats per owner
            const stats = {};

            // Process leads
            leads.forEach(lead => {
                const owner = lead.owner || 'Unassigned';
                if (!stats[owner]) {
                    stats[owner] = { totalLeads: 0, hot: 0, warm: 0, cold: 0, pipeline: 0, meetings: 0 };
                }
                stats[owner].totalLeads++;
                const stage = (lead.stage || '').toLowerCase();
                if (stage === 'hot') stats[owner].hot++;
                else if (stage === 'warm') stats[owner].warm++;
                else if (stage === 'cold') stats[owner].cold++;
            });

            // Process GMeet meetings
            gmeetMeetings.forEach(meet => {
                const owner = meet.leadOwner || 'Unassigned';
                if (!stats[owner]) {
                    stats[owner] = { totalLeads: 0, hot: 0, warm: 0, cold: 0, pipeline: 0, meetings: 0 };
                }
                stats[owner].meetings++;
                const amount = parseFloat(meet.amountPitched.replace(/[^0-9.]/g, '')) || 0;
                stats[owner].pipeline += amount;
            });

            // Summary cards
            const totalUsers = Object.keys(stats).length;
            const totalLeadsAll = leads.length;
            const totalPipelineAll = Object.values(stats).reduce((acc, s) => acc + s.pipeline, 0);
            const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

            document.getElementById('home-summary-stats').innerHTML = `
        <div class="stats-card"><p class="text-gray-400 text-sm">Team Members</p><p class="text-3xl font-bold text-white mt-2">${totalUsers}</p></div>
        <div class="stats-card"><p class="text-gray-400 text-sm">Total Leads</p><p class="text-3xl font-bold text-white mt-2">${totalLeadsAll}</p></div>
        <div class="stats-card"><p class="text-gray-400 text-sm">Total Pipeline</p><p class="text-3xl font-bold text-white mt-2">${formatter.format(totalPipelineAll).replace('₹', '₹')}</p></div>
        <div class="stats-card"><p class="text-gray-400 text-sm">G Meets</p><p class="text-3xl font-bold text-white mt-2">${gmeetMeetings.length}</p></div>
    `;

            // Table rows
            const tbody = document.getElementById('home-table-body');
            tbody.innerHTML = '';
            const sortedOwners = Object.keys(stats).sort();
            sortedOwners.forEach(owner => {
                const s = stats[owner];
                tbody.innerHTML += `<tr>
            <td>${owner}</td>
            <td>${s.totalLeads}</td>
            <td><span class="status-badge status-hot">${s.hot}</span></td>
            <td><span class="status-badge status-warm">${s.warm}</span></td>
            <td><span class="status-badge status-cold">${s.cold}</span></td>
            <td>${formatter.format(s.pipeline).replace('₹', '₹')}</td>
            <td>${s.meetings}</td>
        </tr>`;
            });

        }

        // ========== ADMIN USER MANAGEMENT ==========
        function escapeHTML(value) {
            return String(value || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function getFeatureLabel(featureKey) {
            const found = FEATURE_ACCESS_CONFIG.find((feature) => feature.key === featureKey);
            return found ? found.label : featureKey;
        }

        function renameUserOwnershipReferences(oldName, newName) {
            if (!oldName || !newName || oldName === newName) return;
            leads = leads.map((lead) => lead.owner === oldName ? { ...lead, owner: newName } : lead);
            storeLeads = storeLeads.map((lead) => lead.owner === oldName ? { ...lead, owner: newName } : lead);
            gmeetMeetings = gmeetMeetings.map((meeting) => meeting.leadOwner === oldName ? { ...meeting, leadOwner: newName } : meeting);

            if (columnFilters.owner === oldName) columnFilters.owner = newName;
            if (selectedUser === oldName) selectedUser = newName;
            if (activePopupLead && activePopupLead.owner === oldName) {
                activePopupLead = { ...activePopupLead, owner: newName };
            }
            const ownerInput = document.getElementById('lead-form-owner');
            if (ownerInput && ownerInput.value === oldName) {
                ownerInput.value = newName;
            }
        }

        function updateSelfProfilePicturePreview() {
            const preview = document.getElementById('self-profile-picture-preview');
            const input = document.getElementById('self-profile-picture');
            if (!preview || !input) return;
            const fallback = 'assets/logo.jpg';
            preview.onerror = function () { this.src = fallback; };
            preview.src = input.value.trim() || fallback;
        }

        function openSelfProfileModal() {
            if (!currentUser || !USERS[currentUser]) return;
            const user = USERS[currentUser];
            const canEditEmail = currentRole === 'Admin';

            const nameInput = document.getElementById('self-profile-display-name');
            const emailInput = document.getElementById('self-profile-email');
            const passwordInput = document.getElementById('self-profile-password');
            const pictureInput = document.getElementById('self-profile-picture');
            const emailNote = document.getElementById('self-profile-email-note');
            if (!nameInput || !emailInput || !passwordInput || !pictureInput || !emailNote) return;

            nameInput.value = currentUser;
            emailInput.value = user.email || '';
            passwordInput.value = user.password || '';
            pictureInput.value = user.profilePic || 'assets/logo.jpg';

            emailInput.disabled = !canEditEmail;
            emailNote.classList.toggle('locked', !canEditEmail);
            emailNote.textContent = canEditEmail
                ? 'As an Admin user, you can update your email address.'
                : 'Email can be changed only by Admin users.';

            updateSelfProfilePicturePreview();
            document.getElementById('self-profile-modal').classList.add('active');
        }

        function closeSelfProfileModal() {
            document.getElementById('self-profile-modal').classList.remove('active');
        }

        function saveSelfProfile(event) {
            event.preventDefault();
            if (!currentUser || !USERS[currentUser]) {
                showToast('Unable to locate your profile', true);
                return;
            }

            const oldName = currentUser;
            const existingUser = USERS[oldName];
            const displayName = document.getElementById('self-profile-display-name').value.trim();
            let email = String(document.getElementById('self-profile-email').value || '').trim().toLowerCase();
            const password = document.getElementById('self-profile-password').value.trim();
            const profilePic = document.getElementById('self-profile-picture').value.trim() || 'assets/logo.jpg';

            if (!displayName || !password) {
                showToast('Display name and password are required', true);
                return;
            }
            if (displayName !== oldName && USERS[displayName]) {
                showToast('Another user already has this display name', true);
                return;
            }

            if (currentRole === 'Admin') {
                if (!email) {
                    showToast('Email is required', true);
                    return;
                }
                if (isEmailAlreadyUsed(email, oldName)) {
                    showToast('This email is already assigned to another user', true);
                    return;
                }
            } else {
                email = existingUser.email;
            }

            const normalizedUser = normalizeUserRecord(displayName, {
                password,
                role: existingUser.role,
                email,
                designation: existingUser.designation,
                profilePic,
                featureAccess: existingUser.featureAccess
            });

            if (displayName !== oldName) {
                delete USERS[oldName];
            }
            USERS[displayName] = normalizedUser;
            renameUserOwnershipReferences(oldName, displayName);
            persistUsers();

            currentUser = displayName;
            currentRole = normalizedUser.role;
            document.getElementById('current-user-display').textContent = currentUser;
            document.getElementById('current-role-display').textContent = currentRole;
            document.getElementById('sidebar-role-label').innerText = currentRole === 'Admin' ? 'Admin Dashboard' : `${currentUser}'s Dashboard`;
            document.getElementById('welcome-user').textContent = currentUser;
            applyUserAccessToNavigation();

            if (activeDepartment) {
                populateDropdowns();
                updateStatsAndTable();
            }
            if (!document.getElementById('store-dashboard').classList.contains('hidden-pane')) updateStoreDashboard();
            if (!document.getElementById('gmeet-pane').classList.contains('hidden-pane')) renderGMeetTable();
            if (!document.getElementById('pipeline-pane').classList.contains('hidden-pane')) renderPipeline();
            if (!document.getElementById('home-analytics').classList.contains('hidden-pane')) renderHomeAnalytics();
            if (!document.getElementById('user-management-pane').classList.contains('hidden-pane')) renderUserManagementTable();

            closeSelfProfileModal();
            showToast('Profile updated successfully');
        }

        function renderUserManagementTable() {
            const tbody = document.getElementById('user-management-body');
            if (!tbody) return;

            const users = Object.entries(USERS).sort((a, b) => a[0].localeCompare(b[0]));
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            users.forEach(([name, userData]) => {
                const accessMap = normalizeFeatureAccess(userData.featureAccess, userData.role);
                const enabledLabels = FEATURE_ACCESS_CONFIG
                    .filter((feature) => accessMap[feature.key])
                    .map((feature) => `<span class="user-feature-pill">${feature.label}</span>`)
                    .join('');
                const roleClass = userData.role === 'Admin' ? 'user-role-badge-admin' : 'user-role-badge-team';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="font-medium">${escapeHTML(name)}</td>
            <td>${escapeHTML(userData.email || '-')}</td>
            <td><span class="status-badge ${roleClass}">${escapeHTML(userData.role)}</span></td>
            <td>${escapeHTML(userData.designation || '-')}</td>
            <td><div class="user-feature-summary">${enabledLabels || '<span class="text-gray-500 text-xs">No access</span>'}</div></td>
            <td>
                <div class="flex items-center gap-2">
                    <button class="read-more-btn js-user-edit">Edit</button>
                    <button class="read-more-btn danger-btn js-user-remove">Remove</button>
                </div>
            </td>
        `;

                row.querySelector('.js-user-edit').addEventListener('click', () => openUserManagementModal('edit', name));
                row.querySelector('.js-user-remove').addEventListener('click', () => removeUserFromAdmin(name));
                tbody.appendChild(row);
            });
        }

        function renderFeatureAccessInputs(accessMap) {
            const grid = document.getElementById('feature-access-grid');
            if (!grid) return;
            grid.innerHTML = '';
            FEATURE_ACCESS_CONFIG.forEach((feature) => {
                const label = document.createElement('label');
                label.className = 'feature-access-item';
                label.innerHTML = `
            <input type="checkbox" data-feature-key="${feature.key}" ${accessMap[feature.key] ? 'checked' : ''}>
            <span>${feature.label}</span>
        `;
                grid.appendChild(label);
            });
        }

        function handleUserRoleChangeForAccess() {
            const role = document.getElementById('user-form-role')?.value || 'Team Member';
            const homeAccessCheckbox = document.querySelector('#feature-access-grid input[data-feature-key="home"]');
            if (homeAccessCheckbox) {
                const shouldCheck = role === 'Admin';
                homeAccessCheckbox.checked = shouldCheck;
                homeAccessCheckbox.disabled = true;
            }
        }

        function collectFeatureAccessFromInputs(role) {
            const access = createDefaultFeatureAccess(role);
            document.querySelectorAll('#feature-access-grid input[data-feature-key]').forEach((checkbox) => {
                const key = checkbox.dataset.featureKey;
                if (key) access[key] = Boolean(checkbox.checked);
            });
            return normalizeFeatureAccess(access, role);
        }

        function openUserManagementModal(mode = 'add', userName = null) {
            if (currentRole !== 'Admin') {
                showToast('Only admins can manage users', true);
                return;
            }
            const form = document.getElementById('user-management-form');
            const title = document.getElementById('user-management-title');
            const submit = document.getElementById('user-management-submit-btn');
            if (!form || !title || !submit) return;

            form.dataset.mode = mode;
            const isEdit = mode === 'edit' && userName && USERS[userName];
            const base = isEdit
                ? { name: userName, ...USERS[userName] }
                : {
                    name: '',
                    email: '',
                    password: '',
                    role: 'Team Member',
                    designation: '',
                    profilePic: 'assets/logo.jpg',
                    featureAccess: createDefaultFeatureAccess('Team Member')
                };

            document.getElementById('user-form-original-name').value = isEdit ? userName : '';
            document.getElementById('user-form-name').value = base.name || '';
            document.getElementById('user-form-email').value = base.email || '';
            document.getElementById('user-form-password').value = base.password || '';
            document.getElementById('user-form-role').value = base.role || 'Team Member';
            document.getElementById('user-form-designation').value = base.designation || '';
            document.getElementById('user-form-profile').value = base.profilePic || '';

            renderFeatureAccessInputs(normalizeFeatureAccess(base.featureAccess, base.role));
            handleUserRoleChangeForAccess();

            title.textContent = isEdit ? 'Edit User' : 'Add User';
            submit.innerHTML = isEdit ? '<i class="fas fa-save mr-2"></i>Update User' : '<i class="fas fa-save mr-2"></i>Create User';
            document.getElementById('user-management-modal').classList.add('active');
        }

        function closeUserManagementModal() {
            document.getElementById('user-management-modal').classList.remove('active');
        }

        function getAdminCount() {
            return Object.values(USERS).filter((user) => user.role === 'Admin').length;
        }

        function isEmailAlreadyUsed(email, skipUserName = null) {
            const target = String(email || '').trim().toLowerCase();
            if (!target) return false;
            return Object.entries(USERS).some(([name, user]) => {
                if (skipUserName && name === skipUserName) return false;
                return String(user.email || '').trim().toLowerCase() === target;
            });
        }

        function saveUserFromAdmin(event) {
            event.preventDefault();
            if (currentRole !== 'Admin') {
                showToast('Only admins can manage users', true);
                return;
            }

            const mode = document.getElementById('user-management-form').dataset.mode || 'add';
            const originalName = document.getElementById('user-form-original-name').value.trim();
            const name = document.getElementById('user-form-name').value.trim();
            const email = String(document.getElementById('user-form-email').value || '').trim().toLowerCase();
            const password = document.getElementById('user-form-password').value.trim();
            const role = document.getElementById('user-form-role').value === 'Admin' ? 'Admin' : 'Team Member';
            const designation = document.getElementById('user-form-designation').value.trim() || role;
            const profilePic = document.getElementById('user-form-profile').value.trim() || 'assets/logo.jpg';

            if (!name || !email || !password) {
                showToast('Name, email, and password are required', true);
                return;
            }

            if (isEmailAlreadyUsed(email, mode === 'edit' ? originalName : null)) {
                showToast('This email is already assigned to another user', true);
                return;
            }

            if (mode === 'add' && USERS[name]) {
                showToast('A user with this name already exists', true);
                return;
            }
            if (mode === 'edit' && originalName !== name && USERS[name]) {
                showToast('Another user already has this name', true);
                return;
            }

            const existingUser = mode === 'edit' ? USERS[originalName] : null;
            if (existingUser?.role === 'Admin' && role !== 'Admin' && getAdminCount() <= 1) {
                showToast('At least one admin account must remain', true);
                return;
            }

            const featureAccess = collectFeatureAccessFromInputs(role);
            const normalizedUser = normalizeUserRecord(name, {
                password,
                role,
                email,
                designation,
                profilePic,
                featureAccess
            });

            if (mode === 'edit' && originalName && originalName !== name) {
                delete USERS[originalName];
                renameUserOwnershipReferences(originalName, name);
            }
            USERS[name] = normalizedUser;
            persistUsers();
            closeUserManagementModal();
            renderUserManagementTable();

            if (currentUser === originalName || currentUser === name) {
                const previousUserName = currentUser;
                currentUser = name;
                currentRole = normalizedUser.role;
                document.getElementById('current-user-display').textContent = currentUser;
                document.getElementById('current-role-display').textContent = currentRole;
                document.getElementById('sidebar-role-label').innerText = currentRole === 'Admin' ? 'Admin Dashboard' : `${currentUser}'s Dashboard`;
                applyUserAccessToNavigation();
                if (previousUserName !== currentUser || currentRole !== 'Admin' || !hasFeatureAccess('home')) {
                    routeToDefaultSection();
                }
            }

            showToast(mode === 'edit' ? 'User updated successfully' : 'User created successfully');
        }

        function removeUserFromAdmin(userName) {
            if (currentRole !== 'Admin') {
                showToast('Only admins can manage users', true);
                return;
            }
            if (!USERS[userName]) return;
            if (userName === currentUser) {
                showToast('You cannot remove your currently logged-in account', true);
                return;
            }
            if (USERS[userName].role === 'Admin' && getAdminCount() <= 1) {
                showToast('At least one admin account must remain', true);
                return;
            }

            const confirmed = window.confirm(`Remove user "${userName}"?`);
            if (!confirmed) return;

            delete USERS[userName];
            persistUsers();
            renderUserManagementTable();
            showToast('User removed successfully');
        }

        // ========== NAVIGATION & EXPORT ==========
        function showGMeet() {
            if (!hasFeatureAccess('gmeet')) {
                showToast('G Meet dashboard access is disabled for your account', true);
                return;
            }
            activeDepartment = null;
            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.add('hidden-pane');
            document.getElementById('gmeet-pane').classList.remove('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');
            setActiveNav('gmeet');
            renderGMeetTable();
        }

        function showPipeline() {
            if (!hasFeatureAccess('pipeline')) {
                showToast('Pipeline access is disabled for your account', true);
                return;
            }
            activeDepartment = null;
            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.add('hidden-pane');
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.remove('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');
            setActiveNav('pipeline');
            renderPipeline();
        }

        function exportToExcel() {
            if (activeDepartment) {
                const filtered = filterLeads();
                if (filtered.length === 0 && gmeetMeetings.length === 0) { showToast('No data', true); return; }
                const rows = [];
                rows.push(`${activeDepartment.toUpperCase()} DEPARTMENT LEADS`);
                rows.push(['Name', 'Email', 'Phone', 'Source', 'Budget', 'Owner', 'Stage', 'Remark', 'DateAdded'].join(','));
                filtered.forEach(l => rows.push(`"${l.name}","${l.email}","${l.phone}","${l.source}","${l.budget}","${l.owner}","${l.stage}","${l.remark}","${l.dateAdded || ''}"`));
                rows.push(''); rows.push('G MEET DATA');
                rows.push(['Lead Owner', 'Department', 'Lead Name', 'Date', 'Agenda', 'Outcome', 'Proposal', 'Amount'].join(','));
                let meetings = gmeetMeetings;
                if (currentRole === 'Team Member') meetings = meetings.filter(m => m.leadOwner === currentUser);
                meetings.forEach(m => rows.push(`"${m.leadOwner}","${m.department}","${m.leadName}","${m.meetDate}","${m.agenda}","${m.outcome}","${m.proposalShared}","${m.amountPitched}"`));
                const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${currentUser}_export_${Date.now()}.csv`; a.click();
                showToast('Exported');
            } else {
                let meetings = gmeetMeetings;
                if (currentRole === 'Team Member') meetings = meetings.filter(m => m.leadOwner === currentUser);
                if (meetings.length === 0) { showToast('No G Meet data', true); return; }
                const rows = [];
                rows.push('G MEET DATA');
                rows.push(['Lead Owner', 'Department', 'Lead Name', 'Date', 'Agenda', 'Outcome', 'Proposal', 'Amount'].join(','));
                meetings.forEach(m => rows.push(`"${m.leadOwner}","${m.department}","${m.leadName}","${m.meetDate}","${m.agenda}","${m.outcome}","${m.proposalShared}","${m.amountPitched}"`));
                const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `gmeet_export_${Date.now()}.csv`; a.click();
                showToast('Exported');
            }
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active')); });
        setInterval(() => loadAllData({ silent: true }), 300000);

        // ========== VCUE CONNECT (Cloud WABA Integration) ==========
        function showVCueConnect() {
            if (!hasFeatureAccess('vcueconnect')) {
                showToast('vCue Connect access is disabled for your account', true);
                return;
            }
            activeDepartment = null;
            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.add('hidden-pane');
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.add('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.remove('hidden-pane');
            setActiveNav('vcueconnect');
        }

        function refreshWabaStatus() {
            const statusEl = document.getElementById('waba-status-indicator');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            setTimeout(() => {
                statusEl.innerHTML = '<span class="text-green-400">Connected</span>';
                showToast('vCue Connect WABA status is healthy');
            }, 900);
        }

        function sendWabaTestMessage() {
            const phone = (document.getElementById('waba-test-phone').value || '').trim();
            if (!phone) {
                showToast('Enter recipient number for test message', true);
                return;
            }
            showToast(`Test WhatsApp message queued for ${phone}`);
        }

        function loadWabaWebhookHealth() {
            const statusEl = document.getElementById('waba-webhook-status');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking webhook endpoints...';
            setTimeout(() => {
                statusEl.innerHTML = '<span class="text-green-400">All webhook endpoints active</span>';
                document.getElementById('waba-events-body').innerHTML = `
            <tr><td>${new Date().toLocaleString()}</td><td>message.delivered</td><td><span class="status-badge status-hot">Success</span></td><td>MSG-2026-001</td></tr>
            <tr><td>${new Date().toLocaleString()}</td><td>message.read</td><td><span class="status-badge status-warm">Received</span></td><td>MSG-2026-001</td></tr>
            <tr><td>${new Date().toLocaleString()}</td><td>message.failed</td><td><span class="status-badge status-cold">Retry Queued</span></td><td>MSG-2026-002</td></tr>
        `;
            }, 800);
        }

        // ========== META INTEGRATION FUNCTIONS (for Admin only) ==========
        function showMetaIntegration() {
            if (!hasFeatureAccess('meta')) {
                showToast('Meta Integration access is disabled for your account', true);
                return;
            }
            activeDepartment = null;
            document.getElementById('dept-select-screen').style.display = 'none';
            document.getElementById('department-dashboard').classList.add('hidden-pane');
            document.getElementById('gmeet-pane').classList.add('hidden-pane');
            document.getElementById('pipeline-pane').classList.add('hidden-pane');
            document.getElementById('store-dashboard').classList.add('hidden-pane');
            document.getElementById('home-analytics').classList.add('hidden-pane');
            document.getElementById('user-management-pane').classList.add('hidden-pane');
            document.getElementById('meta-integration-pane').classList.remove('hidden-pane');
            document.getElementById('vcue-connect-pane').classList.add('hidden-pane');
            setActiveNav('meta');

            // Reset any visible detail pane
            document.getElementById('ads-performance-detail').classList.add('hidden');
            document.getElementById('fresh-leads-status').innerText = 'Idle';
        }

        function captureFreshLeads() {
            document.getElementById('fresh-leads-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            setTimeout(() => {
                // Simulate API call
                document.getElementById('fresh-leads-status').innerHTML = '<span class="text-green-400">✓ 3 new leads imported</span>';
                showToast('Fresh leads captured from Meta');
            }, 1500);
        }

        let adsVisible = false;
        function showAdsPerformance() {
            const detailDiv = document.getElementById('ads-performance-detail');
            if (adsVisible) {
                detailDiv.classList.add('hidden');
                adsVisible = false;
            } else {
                detailDiv.classList.remove('hidden');
                adsVisible = true;
                // Load mock data
                const mockCampaigns = [
                    { campaign_name: 'Summer Sale', impressions: 24500, clicks: 820, spend: '12500.00', cpc: '15.24', ctr: '3.35', date_start: '2025-02-01', date_stop: '2025-02-28' },
                    { campaign_name: 'Lead Gen - Digital', impressions: 18700, clicks: 610, spend: '9800.00', cpc: '16.07', ctr: '3.26', date_start: '2025-02-01', date_stop: '2025-02-28' },
                    { campaign_name: 'Retargeting', impressions: 32000, clicks: 1430, spend: '21000.00', cpc: '14.69', ctr: '4.47', date_start: '2025-02-01', date_stop: '2025-02-28' },
                ];
                renderMetaAdsTable(mockCampaigns);
                renderMetaAdsSummary(mockCampaigns);
                // Set date inputs to last 30 days
                const today = new Date();
                const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(today.getDate() - 30);
                document.getElementById('meta-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
                document.getElementById('meta-date-to').value = today.toISOString().split('T')[0];
            }
        }

        function renderMetaAdsTable(campaigns) {
            const tbody = document.getElementById('meta-ads-table-body');
            if (!campaigns || campaigns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No campaign data.</td></tr>';
                return;
            }
            let html = '';
            campaigns.forEach(c => {
                html += `<tr>
            <td class="font-medium">${c.campaign_name}</td>
            <td>${c.impressions}</td>
            <td>${c.clicks}</td>
            <td>₹ ${parseFloat(c.spend).toFixed(2)}</td>
            <td>₹ ${parseFloat(c.cpc).toFixed(2)}</td>
            <td>${parseFloat(c.ctr).toFixed(2)}%</td>
            <td>${c.date_start} to ${c.date_stop}</td>
        </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderMetaAdsSummary(campaigns) {
            let totalSpend = 0, totalImpressions = 0, totalClicks = 0;
            campaigns.forEach(c => {
                totalSpend += parseFloat(c.spend) || 0;
                totalImpressions += parseInt(c.impressions) || 0;
                totalClicks += parseInt(c.clicks) || 0;
            });
            const avgCPC = totalClicks ? (totalSpend / totalClicks).toFixed(2) : 0;
            const avgCTR = totalImpressions ? ((totalClicks / totalImpressions) * 100).toFixed(2) : 0;
            const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
            document.getElementById('meta-ads-summary').innerHTML = `
        <div class="stats-card"><p class="text-gray-400 text-sm">Total Spend</p><p class="text-3xl font-bold text-white mt-2">${formatter.format(totalSpend)}</p></div>
        <div class="stats-card"><p class="text-gray-400 text-sm">Impressions</p><p class="text-3xl font-bold text-white mt-2">${totalImpressions.toLocaleString()}</p></div>
        <div class="stats-card"><p class="text-gray-400 text-sm">Clicks</p><p class="text-3xl font-bold text-white mt-2">${totalClicks.toLocaleString()}</p></div>
        <div class="stats-card"><p class="text-gray-400 text-sm">Avg. CPC</p><p class="text-3xl font-bold text-white mt-2">${formatter.format(avgCPC)}</p></div>
    `;
            document.getElementById('ads-mini-summary').innerHTML = `Last 30d: ₹${totalSpend.toFixed(0)} spend, ${totalClicks} clicks`;
        }

        function applyMetaDateFilter() {
            showToast('Date filter applied (mock)', false);
            // In real app, would fetch new data
        }

        function resetMetaDateFilter() {
            const today = new Date();
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(today.getDate() - 30);
            document.getElementById('meta-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('meta-date-to').value = today.toISOString().split('T')[0];
            showToast('Reset to last 30 days (mock)', false);
        }

        function createCustomAudience() {
            const segment = document.getElementById('audience-segment').value;
            const audienceName = document.getElementById('audience-name').value;
            if (!audienceName) { showToast('Enter audience name', true); return; }
            const statusDiv = document.getElementById('audience-status');
            statusDiv.className = 'mt-2 text-sm text-blue-400';
            statusDiv.innerHTML = 'Creating audience...';
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                const leadsCount = getLeadsForSegment(segment).length;
                statusDiv.className = 'mt-2 text-sm text-green-400';
                statusDiv.innerHTML = `✅ Audience "${audienceName}" created with ${leadsCount} leads. Uploaded to Meta.`;
            }, 1200);
        }

        function getLeadsForSegment(segment) {
            switch (segment) {
                case 'hot': return leads.filter(l => l.stage?.toLowerCase() === 'hot');
                case 'warm': return leads.filter(l => l.stage?.toLowerCase() === 'warm');
                case 'cold': return leads.filter(l => l.stage?.toLowerCase() === 'cold');
                case 'all': return leads;
                case 'store': return storeLeads;
                default: return [];
            }
        }
    </script>
</body>

</html>